---
title: "Effects of Climate Change on Estuarine Fish Assemblages"
abstract: "This is a test abstract"
authors:
  - name: "Garrett Miller"
    orcid: "0009-0007-6253-2554"
    affiliation:
      - name: The University of South Florida
        department: College of Marine Science
format: html
reference-doc: results_formatting.docx
editor: visual
bibliography: references.bib
---

```{r loadLibraries}
#| include: FALSE
library(tidyverse)
library(patchwork)
library(lubridate)
library(vegan)
library(BiodiversityR)
#library(MASS)
#library(colortools)
library(ggrepel)
library(RColorBrewer)
library(egg)
library(ggpmisc) #for labeling
library(broom) #for labeling
library(DHARMa)
library(gridExtra)
library(gridGraphics)
library(grid)
library(pander)
library(pixiedust) #for model output formats

Sys.setenv(FISHBASE_API="sealifebase")
#knitr::opts_chunk$set(echo = TRUE)
```

# Introduction {.unnumbered}

Global climate change is having strong effects on biodiversity and associated ecosystem structure and functions [@Doney2012; @Poloczanska2016; @Murphy2020]. Shifts in species distributions [@McCarty2001], changes in phenology [@Stenseth2002], and changes in biodiversity [@Dornelas2019] have been observed globally. However, the direction and magnitude of change varies. For example, species richness is declining around the equator and increasing at midlatitudes [@Chaudhary2021]. Some taxa are migrating poleward while others remain unchanged in distribution [@Parmesan1999; @Perry2005; @Chivers2017]. Given that changes in biodiversity can affect ecosystem stability [@Hautier2015], there has been increased concern about how climate change will alter ecosystems, including rainforests [@Levine2016], coral reefs [@Toth2019], and estuaries [@Erickson2021]. However, our understanding of changes in ecosystem stability has been limited by a paucity of long-term time series data [but see @Dornelas2018]. Further, many ecosystems at lower latitudes have received comparatively less attention than those at higher latitudes. Understanding stability in these lower latitude ecosystems can shed light on their responses to climate change and broaden our understanding about generalities.

Temperature is known to affect population-level demographics in several ways, including the sex ratio of offspring [@Ospina-Alvarez2008], growth rates of young [@Raventos2021], and individual survivorship [@Stevens2016]. However, the effects of shifting temperatures are more nuanced at the community level. Studies have highlighted such influences as changes in seasonal weather extremes [@Easterling2000; @Miner2021], shifts in season duration [@Cooper2014], and variation in disturbance frequency, intensity, and duration [@Dale2001], among others. Such factors can drive community-level change in different magnitudes and directions. For example, as distributions of taxa shift in response to warming temperature, the invasion of predators and new pathogens can lead to the extirpation of native species [@Sax2007]. Although average temperatures are increasing globally, the magnitude of these changes may not be consistent among seasons, with warming expected to occur more quickly in the winter than the summer for many ecosystems [@Clark2020]. This seasonal imbalance in temperature change has already contributed to the global poleward expansion of mangroves and is linked to a reduction in frequency and intensity of cold weather events [@Saintilan2014]. Given the importance of season on biota globally, such asymmetric change in temperature may have complex effects. For example, the intensity of a preceding winter is associated with differences in the springtime estuarine fish assemblages that follow [@Curran2019]. In addition, the simultaneous increase in temperature variability due to climate change has been demonstrated to directly influence species richness, with concurrent effects on community stability [@Zhang2018]. Within marine systems, there is evidence that regions at lower latitude have become less stable compared to their higher latitude counterparts due to their responses to temperature [@Miner2021].

The eastern Gulf of Mexico (eGOM) is a productive subtropical region that supports diverse communities including mangrove- and marshgrass-dominated estuaries, seagrass systems, and hardbottom reefs. The region is bisected by the Northern Gulf of Mexico ecoregion to the north and Floridian to the south, which are characterized by compositionally different marine assemblages [@Spalding2007]. Seagrass systems across this region act as important juvenile habitats for many fishes and have high regional variability in the populations and communities they support [@Schrandt2018; @Faletti2019; @Peake2022]. Globally, temperate ecosystems are undergoing tropicalization, with previously rare or absent tropically-associated taxa increasing in abundance through time [@Nakamura2013; @Osland2021]. The effects of these invading taxa are profound and can lead to regime shifts [@Verges2014; @Wernberg2016]. Yet, there is evidence that some subtropical ecosystems are resilient to tropicalization due to additional factors, such as dispersal limitations of potential invaders [@Mizerek2021]. In the eGOM, the expansion of three co-occurring mangrove species in Florida estuaries has been linked to reduced frequency of extreme cold events [@Cavanaugh2014] and is already creating novel mangrove-marsh assemblages [@Cook-Patton2015], with shifts in faunal communities predicted to follow [@Scheffel2018]. Indeed, warmer winter temperatures have been associated with the poleward expansion of a mangrove-associated fish species in this region [@Purtlebaugh2020] and affected community stability in other estuarine systems in North America [@Miner2021].

Increased abundance of tropically-associated taxa had already been observed in northern Gulf of Mexico (nGOM) seagrass systems as early as 2006, potentially indicating tropicalization by taxa from the Floridian ecoregion [@Fodrie2010]. However, Fodrie et al. [-@Fodrie2010] was restricted to the northernmost edge of the eGOM as well as only the summer and fall seasons. Further, assemblages commonly differ between summer and winter in subtropical and temperate estuaries [@Hagan2003; @Strydom2015; @Schrandt2020]. Thus, it is unclear how estuarine systems across the broader eGOM may be responding to climate change, especially in the context of imbalanced seasonal temperature change. Long-term data collected consistently within and across multiple eGOM estuaries that span temperate and subtropical latitudes can improve our ability to evaluate the stability of these assemblages and establish a timeline of tropicalization in this region. Long-term time series data are available in the eGOM, where estuarine seine hauls have been conducted monthly since 1997 and followed consistent study designs and methods. Using these data, I will investigate whether fish assemblages in estuaries within the eGOM have changed over a 20-year period in response to climate change. Specifically, I will address the following questions: 1) has the richness and abundance of eGOM estuarine fish assemblages changed over a 20-year period? 2) Has the composition and stability of eGOM estuarine fish assemblages changed over time and, if so, are these changes related to water temperature? 3) Has the within-season variability of eGOM estuarine fish assemblages changed over time?

# Methods {.unnumbered}

### Data collection

This study used data collected by the Florida Fish and Wildlife Research Institute's (FWRI) Fisheries Independent Monitoring (FIM) program. The program follows a monthly stratified random sampling design in estuaries across Florida, including four in the eastern Gulf of Mexico (from north to south: Apalachicola Bay, Cedar Key, Tampa Bay, and Charlotte Harbor; @fig-FIMsystems). Apalachicola Bay is a shallow, semi-enclosed estuary located on the northern coast of the GOM in the panhandle of Florida, USA and is within the Northern Gulf of Mexico ecoregion [@Spalding2007]. Cedar Key is located within the Suwannee River open estuary system and is also in the Northern Gulf of Mexico ecoregion. Tampa Bay is Florida's largest open water estuary and lies within the Floridian ecoregion [@Spalding2007]. Charlotte Harbor, a drowned river estuary system, is within the Floridian ecoregion [@FWRIFloridaFishandWildlifeResearchInstitute2017]. All systems are dominated by seagrass vegetation in shallow waters, except for Apalachicola Bay, where seagrass is less than 7% of bottom coverage [@FWRIFloridaFishandWildlifeResearchInstitute2017]. However, sampling gear was partly determined by habitat, where all seagrass at particular depths were sampled with the same gear type across estuaries [see also below, @FWRIFloridaFishandWildlifeResearchInstitute2017]. Finally, marsh grasses and oyster beds are dominant along shorelines in Apalachicola Bay and Cedar Key, while mangroves dominate in Charlotte Harbor, and Tampa Bay is characterized by a mix of marsh grasses, oyster beds, and mangroves [@FWRIFloridaFishandWildlifeResearchInstitute2017].

![Locations of all estuaries in this study.](conceptFigs/FIMsystems.png){#fig-FIMsystems}

Within each estuary, sampling was divided into zones (subdivided into 1-nm^2^ grids) based on geographic, habitat, and depth criteria [@FWRIFloridaFishandWildlifeResearchInstitute2017]. These criteria defined which of three different types of gear were used to collect organisms. For this study, only the 21.3-m seine net were considered, because it was used the longest and most consistently throughout the study period. Specifically, this gear targeted young-of-year and juvenile fishes in shallow habitats (â‰¤1.8-m deep). For every net deployment, all vertebrates and select commercially important invertebrates were counted and identified to the lowest practical taxonomic level (typically species). This study used all available seine data from 1998 to 2020. Further, each seine haul was categorized by season, with summer defined as June-September and winter as December-March, following [@Schrandt2020]. Due to the similarity in appearance, and thus difficulty for *in situ* species-level identification, certain taxa were aggregated at the genus level to reduce potential effects of misidentification @tbl-diffID. Finally, using a YSI sonde, several parameters, including water temperature, were recorded at the surface of the water and at the bottom during each sampling event.

```{r}
#| label: tbl-diffID
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Difficult to ID taxa"
knitr::kable(read.csv(file = "conceptFigs/diffIDTaxa.csv"))
```

### Data Analyses

```{r}
#| label: Models
#| include: FALSE
#| warning: FALSE
#| cache: TRUE
source("RichnessModel.R")
```

To address if the richness and abundance of eGOM estuarine fish assemblages has changed over a 20-year period, I modeled richness and abundance per haul across all estuaries for both the summer and winter seasons using Generalized Linear Mixed Models (GLMMs). Given the well-documented seasonal differences in estuarine systems (see[@Hagan2003; @Strydom2015; @Schrandt2020]), in this and all subsequent analyses, summer and winter are treated entirely separately. For each seine haul, I calculated the richness as the number of taxa present and total abundance as the sum of all individuals counted. In all calculations, total abundance was fourth-root transformed to reduce the effects of overly-abundant taxa, given total abundance ranged from a maximum of `r max(totAbModelDF$abundRaw)` to `r min(totAbModelDF$abundRaw)`. For each model, the response in the GLMM included either the richness or transformed abundance of each haul, with estuary (four levels) as a fixed effect and year as a random effect. To account for serial autocorrelation, an `ar1` covariance matrix was used in each model calculated from month of sampling event and within-estuary zone. Given that species richness is strongly affected by sampling effort [@Mittelbach2019], I included an offset term to account for variation in the number of seine hauls. Further, I used Permutational Multivariate Analaysis of Variance (PERMANOVA) to examine the interaction between estuary and time, as a means to determine if there are different magnitudes and directions of temporal change among estuaries and thus if each estuary should be treated separately.

To explore whether the composition and abundance has changed over the same time period and if it may be related to water temperature, I used several techniques. First, I examined the turnover and nestedness of each system through time using the R package `betapart`. Then, I ran additional GLMM models for each estuary, but included random terms for Z-scored water temperature and Z-scored percent bottom vegetation coverage (BVC). In all cases, the same `ar1` covariance structure was used as before as well as an offset term for sampling effort. To help visualize the differences among estuaries, I used Non-metric Multidimensional Scaling (NMDS) to plot the average annual abundance of each taxa in each season in multivariate space. Since this is not a routine for hypothesis testing, I used Distance-based Redundancy Analysis (dbRDA) to explore the magnitude and direction of effect of water temperature and BVC in multivariate space. Finally, to explore the *a priori* hypothesis of a possible "directional" change (see concept fig) in species space over time, I used Canonical Analysis of Principal Coordinates (CAP) models for each estuary and season. Following [@Dornelas2019], I further examined individual taxa for change over time. Within each estuary and season, I ran a linear model on the transformed abundance of each taxa independently and tested for significance. This was used to determine both the magnitude and direction of change at the species level, thus describing the distribution of "winners and losers" across each estuarine system.

# Results {.unnumbered}

### Overview

```{r}
#| label: Temp_BVC
#| include: FALSE
#| message: FALSE
#| cache: TRUE
source("tempBVC.R")
winterStats <- filter(SXR_filtered, season == "winter")
summerStats <- filter(SXR_filtered, season == "summer")
winterAbStats <- filter(SXAb, season == "winter")
summerAbStats <- filter(SXAb, season == "summer")

```

In total, 17492 sampling events occurred where at least one taxa was caught and counted during summer or winter across all four estuaries. For seven sampling events, temperature data was unavailable and thus excluded from the analyses. Further, hauls that were comprised solely of rare species (taxa found in â‰¤5% of all samples for that system and season) were removed from the analyses which reduced samples down to `r nrow(SXS_filtered)`. Overall, `r ncol(SXS_filtered_spp)` taxa in the dataset were recorded, spanning `r max(as.numeric(as.character(waterBVC_full$seasonYear)))-min(as.numeric(as.character(waterBVC_full$seasonYear)))` years of collections.

Total richness was significantly changing (positively) only in winter in Tampa Bay ([@fig-NPlot]). However, the total richness in winter (average richness `r round(mean(winterStats$meanN),3)`) was consistently lower for each estuary than in the summer (average richness `r round(mean(summerStats$meanN),3)`). In addition, richness

```{r}
#| label: tbl-fullRichModels
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Richness GLMM"
emphasize.strong.cells(which(richFullPvalues < 0.05, arr.ind = TRUE))
pander(richFullEstimates)
```

```{r}
#| label: fig-NPlot
#| echo: FALSE
#| message: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "An amazing richness plot."
plot(NPlot_ann)
```

Similarly, total abundance was generally lower for all systems in the winter season (average total abundance `r round(mean(winterAbStats$meanAb),3)`), with summer generally higher (average total abundance `r round(mean(summerAbStats$meanAb),3)`) ([@fig-AbundPlot]). Apalachicola Bay (in winter) and Tampa Bay (in summer) both have significant changes in total abundance over time, though AP is changing negatively and TB is changing positively.

```{r}
#| label: tbl-fullAbundModels
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Abundance GLMM"
emphasize.strong.cells(which(abundFullPvalues < 0.05, arr.ind = TRUE))
pander(abundFullEstimates)
```

```{r}
#| label: fig-AbundPlot
#| echo: FALSE
#| message: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "An amazing abundance plot."
plot(AbundPlot_ann)
```

Seagrass coverage over time significantly changed in Cedar Key summer (negatively), Tampa Bay winter (positively), and in both seasons in Charlotte Harbor (positively) ([@fig-BVCPlot]).

```{r BVCPlot}
#| label: fig-BVCPlot
#| echo: FALSE
#| message: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "Yet another amazing plot"
plot(BVCPlot)
```

Temperature increased significantly through time for all estuaries in the winter and for AP and TB in the summer ([@fig-TempPlot]).

```{r}
#| label: fig-TempPlot
#| layout-ncol: 2
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "Charts"
#| fig-subcap: 
#|   - "One more amazing plot"
#|   - "Annually plotted"
plot(fullTemp)
plot(TempPlot)
```

Is there any association between changes in abundance and changes in temperature and/or seagrass coverage? GLMMs used to determine. Formula used for all models is: `abund ~ year_Z + temp_Z +  bvc_Z + offset(log(n_hauls)) + ar1(yearMonth + 0|systemZone)` where abund is ... z is ...

Here's what the abundance model output looks like for each system and season combination in @tbl-abundModels.

```{r}
#| label: tbl-abundModels
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "The first table."
emphasize.strong.cells(which(abundPvalues < 0.05, arr.ind = TRUE))
pander(abundEstimates)
```

And this is for richness models as in @tbl-richModels.

```{r}
#| label: tbl-richModels
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "The second table."
emphasize.strong.cells(which(richPvalues < 0.05, arr.ind = TRUE))
pander(richEstimates)
```

Looking closer at temp, specifically as in [@Miner2021], the upper and lower 10th percentiles of temp are sometimes changing. Mostly in winter, though not significant using linear model alone ([@fig-upperLower]).

```{r}
#| label: fig-upperLower
#| echo: FALSE
#| message: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "Still another amazing plot"
plot(annualTemp)
```

```{r}
#| label: BetaDiversity
#| include: FALSE
#| cache: TRUE
source("BetadiversityPairwise.R")
```

The betadiversity stuff is interesting ([@fig-betadiversity]).

```{r}
#| label: fig-betadiversity
#| echo: FALSE
#| message: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "Betadiversity amazing plot"
plot(betaTimePlot)
```

```{r}
#| label: NMDS
#| include: FALSE
#| cache: TRUE
source("NMDS_annual.R")
```

NMDS plots are cool ([@fig-NMDS_all]).

```{r}
#| label: fig-NMDS_all
#| layout-nrow: 2
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "NMDS plots"
#| fig-subcap: 
#|   - "summer"
#|   - "winter"
plot(summerNMDS)
plot(winterNMDS)
```

```{r}
#| label: PERMANOVA
#| include: FALSE
load("bigPERMANOVAs.RData")
```

```{r}
#| label: tbl-fullPERMANOVAwinter
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Winter PERMANOVA"
emphasize.strong.cells(which(winterfAbundPERM < 0.05, arr.ind = TRUE))
pander(winterfAbundPERM)
```

```{r}
#| label: tbl-fullPERMANOVAsummer
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Summer PERMANOVA"
emphasize.strong.cells(which(summerfAbundPERM < 0.05, arr.ind = TRUE))
pander(summerfAbundPERM)
```

Next up... PERMANOVA! The best is this one [@tbl-fullPERMANOVAwinter]. Estuary \* year significant in the initial test. Thus, needed to separate and run each estuary separately.

After PERMANOVA, needed to look at environmental factors. RDA used for this. SAV and temperature significant in all years and seasons ([@fig-RDAforAll]).

```{r}
#| label: RDA
#| include: FALSE
load("./Outputs/RDAsforAll_Z.RData")
load('SXS_filtered.Rdata')
RDAsforAll <- RDAsforAll_Z

systemSeason_list <- SXS_filtered %>%
  select(systemSeason) %>%
  distinct()

plotsforAll <- list()
#rdaVecslist <- list()
for(i in systemSeason_list$systemSeason){
 print(i)
  mult <- 1
  mult_vec <- 1
  scores_sites <- data.frame(RDAsforAll[[i]]$scores$sites)
  vecs <- data.frame(RDAsforAll[[i]]$env$vectors$arrows)
  #rdaVecslist[[i]] <- vecs
  middles <- data.frame(RDAsforAll[[i]]$scores$centroids)
  plotSub <- SXS_filtered %>% #filter out systemSeason of interest just as in rda loop (df_env)
    filter(systemSeason %in% i) %>%
    select(seasonYear) %>%
    cbind(scores_sites) %>%
    group_by(seasonYear) %>%
    summarise(across(everything(), ~ mean(.x, na.rm = TRUE)))
  # grps <- data.frame(rownames(middles) %>%
  #   str_remove_all("seasonYear")) %>%
  #   rename(seasonYear = rownames.middles......str_remove_all..seasonYear..)
  
  plotsforAll[[i]] <- ggplot(plotSub) +
    geom_vline(xintercept = 0,
               colour     = "grey70",
               size       = 1) +
    geom_hline(yintercept = 0,
               colour     = "grey70",
               size       = 1) +
    scale_x_continuous(limits       = symmetric_range,
                       breaks       = c(-6,-1,0,1,6),
                       minor_breaks = NULL) +
    scale_y_continuous(limits       = symmetric_range,
                       breaks       = c(-6,-1,0,1,6),
                       minor_breaks = NULL) +
    labs(title = i, 
         x     = paste("CA1 (", round(100*RDAsforAll[[i]]$rda$CCA$eig[1]/RDAsforAll[[i]]$rda$tot.chi,2), "%)", sep = ""),
         y     = paste("CA1 (", round(100*RDAsforAll[[i]]$rda$CCA$eig[2]/RDAsforAll[[i]]$rda$tot.chi,2), "%)", sep = ""))+
    scale_color_manual(values = c("blue","darkgreen"),
                       guide  = guide_none()) +
    # geom_point(data = scores_sites,
    #            aes(x = mult*dbRDA1,
    #                y = mult*dbRDA2,
    #            ),
    #            size   = 1,
    #            stroke = 0.1,
    #            pch    = 21,
    #            colour = "black") +
    geom_point(aes(x = mult*dbRDA1,
                   y = mult*dbRDA2,
                   fill = as.numeric(as.character(seasonYear))),
               size   = 4,
               stroke = 0.1,
               pch    = 21,
               colour = "black") +
    scale_fill_gradient(
      low = "red",
      high = "blue",
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    ) +
    theme_bw() +
    theme(legend.text       = element_text(size=rel(0.8)),
          legend.position   = c(0.055,0.89),
          legend.background = element_blank(),
          legend.key        = element_blank(),
          panel.grid        = element_blank()) +
    geom_segment(data = vecs,
                 aes(x     = 0, 
                     xend  = mult_vec*dbRDA1, 
                     y     = 0, 
                     yend  = mult_vec*dbRDA2, 
                     #color = "blue"
                       ),
                 arrow = arrow(length = unit(.1,"inches")),
                 size  = 1,
                 alpha = 0.6) +
    geom_label_repel(data = vecs,
                     aes(x      = mult_vec*dbRDA1,
                         y      = mult_vec*dbRDA2,
                         label  = rownames(vecs),
                         #colour = "blue",
                         #size   = "blue"
                           ),
                     force         = 0.1,
                     alpha         = 0.8,
                     fontface      = "bold",
                     label.padding = 0.25,
                     box.padding   = 0.1,
                     fill          ="white",
                     label.r       = 0.25,
                     label.size    = 0.25,
                     segment.alpha =0,
                     nudge_x       = ifelse(vecs$dbRDA1>0,0.1,-0.1),
                     nudge_y       = ifelse(vecs$dbRDA2>0,0.2,-0.2)) +
    scale_size_manual(values = c(2.5,3.5),
                      guide  = guide_none()) +
    guides(fill = guide_legend(override.aes = list(size = 2.5),
                               keyheight    = 0.15,
                               keywidth     = 0.2,
                               title = "Year"))
  
}

fullRDAPlot <- wrap_plots(plotsforAll,
                      ncol = 4)
```

```{r}
#| label: fig-RDAforAll
#| echo: FALSE
#| message: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "RDA amazing plot"

plot(fullRDAPlot)
```

Look at all these RDAs! ([@fig-RDAforAll])

```{r}
#| label: CAP_processing
#| include: FALSE
load("./Outputs/CAPsforAll_Z.RData")

#source https://github.com/jonpeake/forage-fish-public-code/blob/main/ForageFigures_CODE.R
cap_pctvars <- function(cap_out){
  # A function that takes the output of the CAPdiscrim function and 
  # produces the percent of among-group variability explained by each
  # canonical axis.
  #
  # Inputs: 
  # cap_out = 'CAPDiscrim' function list output
  # 
  # Output: 
  # pct_var = A numerical array with dimensions 1 x p, where p is the
  #           number of canonical axes, corresponding to the percent
  #           of among-group variability explained by each axis.
  #         
  
  # Extract eigenvalues from manova sublist
  eig     <- cap_out[["manova"]][["Eigenvalues"]]
  
  # Convert eigenvalues to analog of canonical variability
  vars    <- eig*cap_out$tot*(cap_out$varm/100)/(eig+1)
  
  # Calculate percent of variability explained by each axis
  pct_var <- t(100*vars/sum(vars))
  
  # Trim rows not corresponding to canonical axes
  pct_var <- pct_var[1:ncol(cap_out$x),]
  return(pct_var)
}

load('TidyGearCode20.Rdata')
load('SXS_filtered.Rdata')

#data setup
#build month dataframe
monthly <- HydroList %>%
  select(Reference, month)

#rejoin with environmental data
SXS_run_env <- SXS_filtered_env %>%
  #left_join(SXS_filtered_env) %>%
  left_join(monthly) %>%
  group_by(systemSeason) %>%
  add_count(name = "n_hauls") %>% #count number of hauls per systemSeason
  ungroup() %>%
  group_by(systemSeason, seasonYear) %>%
  mutate(avg_temp = mean(Temperature, na.rm = TRUE),
         n_temp = n(),
         upper = quantile(Temperature, 0.9),
         lower = quantile(Temperature, 0.1),
         sd_ann = sd(Temperature)) %>%
  ungroup() %>%
  group_by(systemSeason) %>%
  mutate(avg_ltm = mean(avg_temp),
         sd_ltm = sd(avg_temp, na.rm = TRUE),
         upper_sd = sd(upper),
         lower_sd = sd(lower)) %>%
  mutate(anom_temp = avg_temp - avg_ltm,
         se_temp = sd_ltm/sqrt(n_temp),
         lower.ci.anom.temp = 0 - (1.96 * se_temp),
         upper.ci.anom.temp = 0 + (1.96 * se_temp)) %>%
  #zscoreing
  mutate(bvc_ltm  = mean(BottomVegCover, na.rm = TRUE),
         bvc_sd   = sd(BottomVegCover, na.rm = TRUE),
         temp_ltm = mean(Temperature, na.rm = TRUE),
         temp_sd  = sd(Temperature, na.rm = TRUE),
         year_ltm = mean(as.numeric(as.character(seasonYear)), na.rm = TRUE),
         year_sd  = sd(as.numeric(as.character(seasonYear)), na.rm = TRUE),
         bvc_Z    = ((BottomVegCover - bvc_ltm)/bvc_sd),
         temp_Z   = ((Temperature - temp_ltm)/temp_sd),
         year_Z    = ((as.numeric(as.character(seasonYear)) - year_ltm)/year_sd),
         sd_t_Z   = sd(temp_Z)) %>%
  #monthly
  ungroup() %>%
  group_by(systemSeason, seasonYear, month) %>%
  mutate(avg_temp_mon = mean(Temperature, na.rm = TRUE),
         n_temp_mon = n(),
         upper_mon = quantile(Temperature, 0.9),
         lower_mon = quantile(Temperature, 0.1),
         upper_Z  = quantile(temp_Z, 0.9),
         lower_Z  = quantile(temp_Z, 0.1),
         sd_mon = sd(Temperature),
         se_mon = sd_mon/sqrt(n_temp_mon))

systemSeason_list <- SXS_filtered %>%
  select(systemSeason) %>%
  distinct()

### centroids ####
for(i in systemSeason_list$systemSeason){
  df <- SXS_filtered %>% #filter out systemSeason of interest
    filter(systemSeason %in% i)
  
  df_spe_filtered <- SXS_filtered %>%
    filter(Reference %in% df$Reference) %>%
    subset(select = -c(systemSeason, seasonYear, Reference, systemZone, BottomVegCover, Temperature)) %>%
    select(which(!colSums(., na.rm=TRUE) %in% 0)) #select only taxa present in this systemSeason
  
  df_env <- data.frame(SXS_run_env %>% #pull out environmental variables
                         filter(Reference %in% df$Reference) %>%
                         subset(select = c(systemSeason, seasonYear, bvc_Z, temp_Z)) %>%
                         mutate(contYear = as.numeric(as.character(seasonYear))))

CAPsforAll[[i]]$centroids <- centroids.long(sites.long(ordiplot(CAPsforAll[[i]])),
                                            df_env$seasonYear,
                                            centroids.only = TRUE)
}

##### centroids with sppvec plots #######
#need fixed range of sppvecs first
sppvecs_list <- list()
sppvecs_list_fix <- list()
for(i in systemSeason_list$systemSeason){
spp_vecs <- data.frame(CAPsforAll[[i]]$cproj) %>%
  arrange(desc(abs(LD1))) %>%
  slice_head(n = 10)
sppvecs_list_fix[[i]] <- spp_vecs
}
sppvecs_list_fixdf <- bind_rows(sppvecs_list_fix)

centroidPlots <- list()
for(i in systemSeason_list$systemSeason){
  print(i) #watch progress through list
  var_CA <- round(cap_pctvars(CAPsforAll[[i]]), 2)
  #var_CA <- round(100 * CAPsforAll[[i]][["lda.other"]][["svd"]]^2/sum(CAPsforAll[[i]][["lda.other"]][["svd"]]^2), 2)
  site_scores <- data.frame(CAPsforAll[[i]]$x)
  middles <- data.frame(CAPsforAll[[i]]$centroids)
  spp_vecs <- data.frame(CAPsforAll[[i]]$cproj) %>%
                           arrange(desc(abs(LD1))) %>%
                           slice_head(n = 10) #grab only top 10 for axis 1 and plot
  sppvecs_list[[i]] <- spp_vecs
  mult <- 6
  centroidPlots[[i]] <- ggplot(middles) + 
    geom_vline(xintercept = 0,
               colour     = "grey70",
               size       = .25) +
    geom_hline(yintercept = 0,
               colour     = "grey70",
               size       = .25) +
    scale_x_continuous(limits       = symmetric_range((1+mult)*sppvecs_list_fixdf$LD1),
                       breaks       = c(-6,-3,0,3,6),
                       minor_breaks = NULL) +
    scale_y_continuous(limits       = symmetric_range((1+mult)*sppvecs_list_fixdf$LD2),
                       breaks       = c(-6,-3,0,3,6),
                       minor_breaks = NULL) +
    geom_point(aes(x    = axis1c, 
                   y    = axis2c, 
                   fill = as.numeric(as.character(df_env.seasonYear))),
               size   = 4, 
               stroke = 0.1,
               pch    = 21, 
               colour = "black") +
    labs(title = i,
         x     = paste("CA1 (",var_CA[1],"%)",sep=""),
         y     = paste("CA2 (",var_CA[2],"%)",sep=""),
         fill  = NULL) +
    scale_fill_gradient(
      low = "red",
      high = "blue",
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    ) +
    theme_bw() +
    theme(legend.text       = element_text(size=rel(0.8)),
          legend.position   = c(0.055,0.89),
          legend.background = element_blank(),
          legend.key        = element_blank(),
          panel.grid        = element_blank()) +
    geom_segment(data = spp_vecs,
                 aes(x    = 0,
                     xend = mult*LD1,
                     y    = 0,
                     yend = mult*LD2),
                 arrow = arrow(length = unit(0.1,"inches")),
                 color = "grey1",
                 size  = .75,
                 alpha = 0.6)+
  geom_label_repel(data = spp_vecs,
                   aes(x     = mult*LD1 + 0.2*cos(atan(LD2/LD1))*sign(LD1),
                       y     = mult*LD2 + 0.2*sin(atan(LD2/LD1))*sign(LD2),
                       label = rownames(spp_vecs)),
                   segment.alpha = 0,
                   size          = 3.25,
                   color         = "blue",
                   fontface      = "bold",
                   fill          = "white",
                   alpha         = 0.7,
                   box.padding   = .25,
                   lineheight    = 0.4,
                   label.size    = 0.25,
                   nudge_x       = ifelse(spp_vecs$LD1>0,0.05,-0.05),
                   nudge_y       = ifelse(spp_vecs$LD2>-0.02,0.05,-0.05),
                   force         = 0.3) +
  guides(fill = guide_legend(override.aes = list(size = 2.5),
                             keyheight    = 0.15,
                             keywidth     = 0.2))
  
}

centroidCAP <- wrap_plots(centroidPlots,
           ncol = 4)
```

```{r}
#| label: fig-centroidCAP
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "CAP amazing plot"

plot(centroidCAP)
```

Now, which taxa are actually changing? Initial look using CAP ([@fig-centroidCAP]). Centroids of each year with red being older and blue being more recent. Most seem to have no discernible patterns, except for Cedar Key summer, where there appears to be a "pre" and "post" era. Because of this, we went back and performed a post-analysis PERMANOVA on this year and season to look closer.

So, how does this compare to others? Like Dornelas, we examined which taxa were the winners and losers. Generally, the number of taxa changing significantly is fairly well balanced between summer and winter. Exception to this is Tampa Bay winter *only*Â had significant positively changing taxa ([@fig-winnersLosers]).

```{r}
#| label: DeltaTaxa
#| include: FALSE
#| message: FALSE
#| cache: TRUE
source("DeltaTaxa.R")
```

```{r}
#| label: fig-winnersLosers
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "Winners losers plot"

winnersLosers
```

Then we look at the groups of each taxa. 
\blandscape
```{r}
#| label: fig-sigSlopes
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 9
#| fig-height: 7.5
#| fig-cap: "Sig slopes plot"

sigSlopesAll
```
\elandscape

Finally the climatology of the taxa.
