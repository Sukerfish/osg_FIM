---
title: "Effects of Climate Change on Estuarine Fish Assemblages"
abstract: "This is a test abstract"
authors:
  - name: "Garrett Miller"
    orcid: "0009-0007-6253-2554"
    affiliation:
      - name: The University of South Florida
        department: College of Marine Science
format:
  html:
    self-contained: true
    toc: true
    toc-location: left
    toc-expand: true
reference-doc: results_formatting.docx
editor: visual
bibliography: references.bib
---

```{r loadLibraries}
#| include: FALSE
library(tidyverse)
library(patchwork)
library(lubridate)
library(vegan)
library(BiodiversityR)
#library(MASS)
#library(colortools)
library(ggrepel)
library(RColorBrewer)
library(egg)
library(ggallin)
library(ggpmisc) #for labeling
library(broom) #for labeling
library(DHARMa)
library(gridExtra)
library(gridGraphics)
library(grid)
library(pander)
library(pixiedust) #for model output formats
library(emmeans)

Sys.setenv(FISHBASE_API="sealifebase")
#knitr::opts_chunk$set(echo = TRUE)
```

# Introduction {#sec-introduction .unnumbered}

Global climate change is having strong effects on biodiversity and associated ecosystem structure and functions [@Doney2012; @Poloczanska2016; @Murphy2020]. Shifts in species distributions [@McCarty2001], changes in phenology [@Stenseth2002], and changes in biodiversity [@Dornelas2019] have been observed globally. However, the direction and magnitude of change varies. For example, species richness is declining around the equator and increasing at midlatitudes [@Chaudhary2021]. Some taxa are migrating poleward while others remain unchanged in distribution [@Parmesan1999; @Perry2005; @Chivers2017]. Given that changes in biodiversity can affect ecosystem stability [@Hautier2015], there has been increased concern about how climate change will alter ecosystems, including rainforests [@Levine2016], coral reefs [@Toth2019], and estuaries [@Erickson2021]. However, our understanding of changes in ecosystem stability has been limited by a paucity of long-term time series data [but see @Dornelas2018]. Further, many ecosystems at lower latitudes have received comparatively less attention than those at higher latitudes. Understanding stability in these lower latitude ecosystems can shed light on their responses to climate change and broaden our understanding about generalities.

Temperature is known to affect population-level demographics in several ways, including the sex ratio of offspring [@Ospina-Alvarez2008], growth rates of young [@Raventos2021], and individual survivorship [@Stevens2016]. However, the effects of shifting temperatures are more nuanced at the community level. Studies have highlighted such influences as changes in seasonal weather extremes [@Easterling2000; @Miner2021], shifts in season duration [@Cooper2014], and variation in disturbance frequency, intensity, and duration [@Dale2001], among others. Such factors can drive community-level change in different magnitudes and directions. For example, as distributions of taxa shift in response to warming temperature, the invasion of predators and new pathogens can lead to the extirpation of native species [@Sax2007]. Although average temperatures are increasing globally, the magnitude of these changes may not be consistent among seasons, with warming expected to occur more quickly in the winter than the summer for many ecosystems [@Clark2020]. This seasonal imbalance in temperature change has already contributed to the global poleward expansion of mangroves and is linked to a reduction in frequency and intensity of cold weather events [@Saintilan2014]. Given the importance of season on biota globally, such asymmetric change in temperature may have complex effects. For example, the intensity of a preceding winter is associated with differences in the springtime estuarine fish assemblages that follow [@Curran2019]. In addition, the concurrent increase in temperature variability due to climate change has been demonstrated to directly influence species richness, with concurrent effects on community stability [@Zhang2018]. Within marine systems, there is evidence that regions at lower latitude have become less stable compared to their higher latitude counterparts due to their responses to temperature [@Miner2021].

The eastern Gulf of Mexico (eGOM) is a productive subtropical region that supports diverse communities including mangrove- and marshgrass-dominated estuaries, seagrass systems, and hardbottom reefs. The region is bisected by the Northern Gulf of Mexico ecoregion to the north and Floridian to the south, which are characterized by compositionally different marine assemblages [@Spalding2007]. Seagrass systems throughout the eGOM act as important juvenile habitats for many fishes and exhibit high regional variability in the populations and communities they support [@Schrandt2018; @Faletti2019; @Peake2022]. Globally, temperate ecosystems are undergoing tropicalization, with previously rare or absent tropically-associated taxa increasing in abundance through time [@Nakamura2013; @Osland2021]. The effects of these invading taxa are profound and can lead to regime shifts [@Verges2014; @Wernberg2016]. Yet, there is evidence that some subtropical ecosystems are resilient to tropicalization due to additional factors, such as dispersal limitations of potential invaders [@Mizerek2021]. In the eGOM, a reduced frequency of extreme cold events has been linked to the expansion of three co-occurring mangrove species in Florida estuaries [@Cavanaugh2014]. This is already creating novel mangrove-marsh assemblages [@Cook-Patton2015] and shifts in faunal communities are predicted to follow [@Scheffel2018]. Indeed, warmer winter temperatures have been associated with the poleward expansion of a mangrove-associated fish species in this region [@Purtlebaugh2020] and has affected community stability in other estuarine systems in North America [@Miner2021].

Increased abundance of tropically-associated taxa had already been observed in northern Gulf of Mexico seagrass systems as early as 2006, potentially indicating tropicalization by taxa from the Floridian ecoregion [@Fodrie2010]. However, Fodrie et al. [-@Fodrie2010] was restricted to the northernmost edge of the eGOM as well as only the summer and fall seasons. Further, assemblages commonly differ between summer and winter in subtropical and temperate estuaries [@Hagan2003; @Strydom2015; @Schrandt2020]. Thus, it is unclear how estuarine systems across the broader eGOM may be responding to climate change, especially in the context of imbalanced changes in average seasonal temperatures. Long-term data collected consistently within and across multiple eGOM estuaries that span temperate and subtropical latitudes can improve our ability to evaluate the stability of these assemblages and establish a timeline of tropicalization in this region. Long-term time series data are available in the eGOM, where estuarine fish composition and abundance data have been conducted monthly since 1997 and followed consistent study designs and methods. Using these data, I investigated whether fish assemblages in estuaries within the eGOM changed over a 20-year period and if there is a potential response to climate change. Specifically, I addressed the following questions: 1) Has water temperature and submerged aquatic vegation coverage changed in eGOM estuaries over a 20-year period? 2) Has the richness and abundance of fishes within eGOM estuarine fish assemblages changed over this same time period and, if so, are these changes related to water temperature? 3) Has the composition and stability of eGOM estuarine fish assemblages changed over time?

# Methods {#sec-methods .unnumbered}

### Data Collection {#sec-data-collection}

This study used data collected by the Florida Fish and Wildlife Research Institute's (FWRI) Fisheries Independent Monitoring (FIM) program. The program follows a monthly stratified random sampling design in estuaries across Florida, including four in the eastern Gulf of Mexico (from north to south: Apalachicola Bay (AB), Cedar Key (CK), Tampa Bay (TB), and Charlotte Harbor (CH); @fig-FIMsystems). Apalachicola Bay is a shallow, semi-enclosed estuary located on the northern coast of the GOM in the panhandle of Florida, USA and is within the Northern Gulf of Mexico ecoregion [@Spalding2007]. Cedar Key is located within the Suwannee River open estuary system and is also in the Northern Gulf of Mexico ecoregion. Tampa Bay is Florida's largest open water estuary and lies within the Floridian ecoregion [@Spalding2007]. Charlotte Harbor, a drowned river estuary system, is within the Floridian ecoregion [@FWRIFloridaFishandWildlifeResearchInstitute2017]. All systems are dominated by seagrass vegetation in shallow waters, except for Apalachicola Bay, where seagrass is less than 7% of bottom coverage [@FWRIFloridaFishandWildlifeResearchInstitute2017]. However, sampling gear was partly determined by habitat, where all seagrass at particular depths were sampled with the same gear type across estuaries [see also below, @FWRIFloridaFishandWildlifeResearchInstitute2017]. Finally, marsh grasses and oyster beds are dominant along shorelines in Apalachicola Bay and Cedar Key, while mangroves dominate in Charlotte Harbor, and Tampa Bay is characterized by a mix of marsh grasses, oyster beds, and mangroves [@FWRIFloridaFishandWildlifeResearchInstitute2017].

![Locations of all estuaries in this study.](conceptFigs/FIMsystems.png){#fig-FIMsystems}

Within each estuary, sampling was divided into zones (subdivided into 1-nm^2^ grids) based on geographic, habitat, and depth criteria [@FWRIFloridaFishandWildlifeResearchInstitute2017]. These criteria defined which of three different types of gear were used to collect organisms. For this study, only the 21.3-m seine net data were considered, because it was used the longest and most consistently throughout the study period. Specifically, this gear targeted young-of-year and juvenile fishes in shallow habitats (≤1.8-m deep). For every net deployment, all vertebrates and select commercially important invertebrates were counted and identified to the lowest practical taxonomic level (typically species). This study used all available seine data from 1998 to 2020. Further, each seine haul was categorized by season, with summer defined as June-September and winter as December-March, following [@Schrandt2020]. Due to the similarity in appearance, and thus difficulty for *in situ* species-level identification, certain taxa were aggregated at the genus level to reduce potential effects of misidentification ([@tbl-diffID]). A visual estimate of the submerged aquatic vegetation coverage was recorded for each sampling event. Finally, a YSI sonde was used to record water temperature at the surface of the water and at the bottom during each sampling event.

```{r}
#| label: tbl-diffID
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Difficult to ID taxa"
knitr::kable(read.csv(file = "conceptFigs/diffIDTaxa.csv"))
```

```{r}
#| label: Models
#| include: FALSE
#| warning: FALSE
#| cache: FALSE
source("RichnessModel.R")

```

```{r}
#| label: Temp_BVC
#| include: FALSE
#| message: FALSE
#| cache: TRUE
source("tempBVC.R")

abundStats <- SXS_filtered %>%
  select(!c(systemSeason, seasonYear, systemZone, BottomVegCover, Temperature)) %>%
  pivot_longer(cols = !c(Reference),
               names_to = "taxa") %>% #pivot to reference and taxa only
  mutate(nRaw = value^4) %>%
  group_by(Reference) %>%
  summarise(abundRaw = sum(nRaw)) %>% #sum all abundance values 
  mutate(abund = abundRaw^0.25) %>%
  left_join(SXS_filtered) %>%
  ungroup() %>%
    separate(systemSeason,
           c("system","season"),
           sep = "_",
           remove = FALSE) %>%
  group_by(season) %>%
  summarise(meanAb = mean(abundRaw),
            sdAb = sd(abundRaw),
            nAb = length(abundRaw),
            q10Ab = quantile(abundRaw, 0.1),
            q90Ab = quantile(abundRaw, 0.9)) %>%
  mutate(seAb = sdAb/sqrt(nAb))

nStats <- SXR_filtered_spp %>%
  left_join(SXS_filtered_env) %>%
  left_join(monthly) %>%
  group_by(systemSeason) %>%
  add_count(name = "n_hauls") %>% #count number of hauls per systemSeason
  ungroup() %>%
    separate(systemSeason,
           c("system","season"),
           sep = "_",
           remove = FALSE) %>%
  group_by(season) %>%
  summarise(meanBVC = mean(BottomVegCover),
            meanTemp = mean(Temperature),
            meanN = mean(N),
            sdTemp = sd(Temperature),
            sdBVC = sd(BottomVegCover),
            sdN = sd(N),
            nTemp = length(Temperature),
            nBVC = length(BottomVegCover),
            nN = length(N),
            q10Temp = quantile(Temperature, 0.1),
            q10BVC = quantile(BottomVegCover, 0.1),
            q10N = quantile(N, 0.1),
            q90Temp = quantile(Temperature, 0.9),
            q90BVC = quantile(BottomVegCover, 0.9),
            q90N = quantile(N, 0.9)) %>%
  mutate(seTemp = sdTemp/sqrt(nTemp),
         seBVC = sdBVC/sqrt(nBVC),
         seN = sdN/sqrt(nN))

hydroSummary <- waterBVC_full %>%
  group_by(season) %>%
  summarise(meanTempFull = mean(meanTemp),
            meanBVCFull = mean(meanBVC),
            sdTempFull = sd(meanTemp),
            sdBVCFull = sd(meanBVC),
            nTempFull = length(meanTemp),
            nBVCFull = length(meanBVC),
            seTempFull = sdTempFull/sqrt(nTempFull),
            seBVCFull = sdBVCFull/sqrt(nBVCFull))

#pairwise emmeans
winterSummaryAll <- lsmeans(winterLm, spec = "system", contr = "revpairwise")
summerSummaryAll <- lsmeans(summerLm, spec = "system", contr = "revpairwise")

winterSumAll <- tidy(winterSummaryAll$lsmeans)
summerSumAll <- tidy(summerSummaryAll$lsmeans)

#pairwise slope checks
winterContrasts <- lstrends(winterLm, ~ system, var = "smallYear", contr = "revpairwise")
summerContrasts <- lstrends(summerLm, ~ system, var = "smallYear", contr = "revpairwise")

winterSlope <- tidy(winterContrasts$lstrends)
summerSlope <- tidy(summerContrasts$lstrends)

winterSummary <- tidy(summary.lm(winterLm))
summerSummary <- tidy(summary.lm(summerLm))

winterBVCSummary <- tidy(summary.lm(winterBVCLm))
summerBVCSummary <- tidy(summary.lm(summerBVCLm))

#pairwise emmeans
winterSummaryBVCAll <- lsmeans(winterBVCLm, spec = "system", contr = "revpairwise")
summerSummaryBVCAll <- lsmeans(summerBVCLm, spec = "system", contr = "revpairwise")

winterSumBVCAll <- tidy(winterSummaryBVCAll$lsmeans)
summerSumBVCAll <- tidy(summerSummaryBVCAll$lsmeans)

#pairwise slope checks
winterBVCContrasts <- lstrends(winterBVCLm, ~ system, var = "smallYear", contr = "revpairwise")
summerBVCContrasts <- lstrends(summerBVCLm, ~ system, var = "smallYear", contr = "revpairwise")

BVCwinterSlope <- tidy(winterBVCContrasts$lstrends)
BVCsummerSlope <- tidy(summerBVCContrasts$lstrends)
```

In total, 17492 sampling events occurred where at least one taxon was caught and counted during summer or winter in any of the four estuaries. For seven sampling events, temperature data were unavailable and thus excluded from the analyses. Further, hauls that were composed solely of rare species (taxa found in ≤5% of all samples for that system and season) were removed from the analyses which reduced the sample count down to `r nrow(SXS_filtered)`. Overall, `r ncol(SXS_filtered_spp)` taxa were recorded in the dataset over `r max(as.numeric(as.character(waterBVC_full$seasonYear)))-min(as.numeric(as.character(waterBVC_full$seasonYear)))` years of collections.

### Data Analyses {#sec-data-analyses}

All analyses were conducted using the R Statistical Computing Environment v4.3.0 and an alpha of 0.05 was used for all significance testing [@R2023]. To address if water temperature and SAV have changed over time in eGOM estuaries, I used Analysis of Covariance (ANCOVA) models for summer and winter seasons, independently, with year as a continuous predictor and estuarine system as a categorical predictor (fixed, 4 levels: Apalachicola Bay, Cedar Key, Tampa Bay, Charlotte Harbor) while including the interaction between both. The response for each model was the mean annual water temperature or percent SAV coverage for each season. Preliminary analyses included simple linear models of annual means of water temperature and bottom vegetation coverage for summer and winter, independently. After visual inspection, the anomalously cold winter of 2010 [@stith2012] appeared as a distinct outlier and was therefore dropped from the winter water temperature ANCOVA. I performed post-hoc contrasts for any significant terms in these ANCOVA models to determine the magnitude of any specific differences across systems using the *emmeans* package and used the Tukey method for *p*-value correction [@emmeans].

To address if the richness and abundance of fishes within eGOM estuarine fish assemblages has changed over the study period and if it may be related to water temperature, I modeled richness and abundance per haul across all estuaries for both the summer and winter seasons using generalized linear mixed models (GLMMs) from the R package *glmmTMB* [@glmmTMB]. Given the well-documented seasonal differences in estuarine systems [see @Hagan2003; @Strydom2015; @Schrandt2020], in this and all subsequent analyses, summer and winter are treated entirely separately. For each seine haul, I calculated the richness as the number of taxa present and total abundance as the sum of all individuals counted. In all calculations, total abundance was fourth-root transformed to reduce the effects of overly-abundant taxa. For each model, the response in the GLMM included either the total richness or transformed total abundance of each haul, with estuary (fixed, 4 levels: Apalachicola Bay, Cedar Key, Tampa Bay, Charlotte Harbor), year (random, continuous; including the interaction), water temperature (random, continuous), and percent SAV coverage (random, continuous) as predictors. Water temperature and percent SAV coverage were subsequently z-score transformed to reduce analytical biases due to differences in scale. An `ar1` covariance matrix was included in each model to account for serial autocorrelation and was calculated from month of sampling event and within-estuary zone. Given that species richness is strongly affected by sampling effort [@Mittelbach2019], I included an offset term to account for variation in the number of seine hauls. Thus, the formula used for each was: `response ~ smallYear * system + temp_Z + sav_Z + offset(log(n_hauls)) + ar1(yearMonth + 0|systemZone)` where `response` was either total abundance or total richness per haul. The package *emmeans* was again used for post-hoc contrasts and the Tukey method was used for *p*-value correction [@emmeans]. In addition, I used the R package *betapart* to calculate Bray-Curtis dissimilarity over time and modeled this with ANCOVA [@betapart].

To address my third question, I first used permutational multivariate analysis of variance (PERMANOVA) from the R package *vegan* to examine the interaction between estuary (fixed, four levels) and year (random, continuous) within season, as a means to determine if there were different magnitudes and directions of temporal change among estuaries and thus if each estuary should be treated separately [@vegan]. I then followed up with canonical analysis of principal coordinates (CAP) ordinations using the R package *BiodiversityR* to visualize differences among the levels of any fixed effect categorical terms deemed significant by the PERMANOVA models [@BiodiversityR]. In addition, I included taxon biplot correlation vectors in these CAP models to help better visualize which taxa were contributing to these differences. Vector lengths were calculated by applying Pythagorean theorem to the first two axis scores for each taxon. Finally, I performed distance-based redundancy analysis (dbRDA) from the R package *vegan* to examine whether water temperature and SAV coverage affected the relative abundances of the different taxa [@vegan].

Additionally, I examined the change in abundance of individual taxa over time following Dornelas et al. [-@Dornelas2019]. Within each estuary and season, I ran a linear model on the fourth-root transformed abundance of each taxon independently over time to determine both the magnitude and direction of change at the taxa level. I then attached climatological association data to any taxon with significant change over time using data pulled from Fishbase using *rfishbase* [@rfishbase]. Unless otherwise indicated, values from these analyses were reported as mean ± SE.

# Results {#sec-results .unnumbered}

```{r}
#| label: DeltaTaxa
#| include: FALSE
#| message: FALSE
#| cache: TRUE
source("DeltaTaxa.R")

sigSummaryShort <- sigSummary %>%
  select(system, season, count, sigCount, posCount, negCount)

posSigRaw <- t.test(pos_percent ~ season, data = sigSummary)
posSig <- broom::tidy(posSigRaw)
negSigRaw <- t.test(neg_percent ~ season, data = sigSummary)
negSig <- broom::tidy(negSigRaw)
sigSigRaw <- t.test(sig_percent ~ season, data = sigSummary)
sigSig <- broom::tidy(sigSigRaw)

sigDiff <- sigSummary %>%
  mutate(diff = abs(posCount - negCount)) %>%
  group_by(season) %>%
  summarise(diff)

sigDelRaw <- t.test(diff ~ season, data = sigDiff)
sigDel <- broom::tidy(sigDelRaw)

winDiff <- sigDiff %>%
  filter(season == "winter")

sumDiff <- sigDiff %>%
  filter(season == "summer")

minSlope <- which(abs(sigSlopes$raw_slope - 0) == min(abs(sigSlopes$raw_slope - 0)))

minSpSlope <- sigSlopes[minSlope,]
```

### Overview {#sec-overview}

Throughout the study period, water temperature was increasing during winter for all systems at a rate nearly double that observed during the summer ([@fig-TempPlot]). However, percent submerged aquatic vegetation (SAV) had a more nuanced response over time, with increases observed in Charlotte Harbor and Tampa Bay, a decrease in Cedar Key winter, and no change in Apalachicola Bay ([@fig-BVCPlot]). In terms of individual taxa, `r length(unique(sigSlopes$Scientificname))` out of `r ncol(SXS_filtered_spp)` total identified taxa had significant changes in abundance over time across all systems.

### Habitat Parameters {#sec-habitat-parameters}

Results of the water temperature ANCOVAs indicated a significant positive trend that was consistent among estuaries. However, it also identified differences in mean temperature across some systems (*t* ≥ `r format(winterSummary$statistic[4], digits = 4)` for all *p* < 0.05; [@tbl-tempAncova]). Using post-hoc contrasts, I parsed out these differences among estuaries and seasons. For the summer season, Charlotte Harbor averaged warmer than all other systems at `r format(summerSumAll[4,]$estimate, digits = 3)`°C ± `r format(summerSumAll[4,]$std.error, digits = 2)` (*t* ≥ `r format(as.data.frame(summerSummaryAll$contrasts)[6,5], digits = 4)` for all *p* < 0.05; [@tbl-tempAncovaContrast]). Average water temperatures in Cedar Key and Apalachicola Bay were not different from one another (`r format(summerSumAll[1,]$estimate, digits = 3)`°C ± `r format(summerSumAll[1,]$std.error, digits = 2)`), although Tampa Bay averaged `r format(summerSumAll[3,]$estimate, digits = 3)`°C ± `r format(summerSumAll[3,]$std.error, digits = 2)` and was significantly different than Cedar Key, but not Apalachicola Bay. However, for the winter season, I determined Apalachicola Bay and Cedar Key averaged `r format(winterSumAll[1,]$estimate, digits = 3)`°C ± `r format(winterSumAll[1,]$std.error, digits = 2)` during the study period, compared to `r format(winterSumAll[3,]$estimate, digits = 3)`°C ± `r format(winterSumAll[3,]$std.error, digits = 2)` for Tampa Bay and `r format(winterSumAll[4,]$estimate, digits = 3)`°C ± `r format(winterSumAll[4,]$std.error, digits = 2)` for Charlotte Harbor (*t* ≥ `r format(as.data.frame(winterSummaryAll$contrasts)[6,5], digits = 4)` for all *p* < 0.05; [@tbl-tempAncovaContrast]). During summer, water temperature increased in all systems at a rate of `r format(summerSummary[2,]$estimate, digits = 2)`°Cyr^-1^ ± `r format(summerSummary[2,]$std.error, digits = 2)` ([@fig-TempPlot]). For all systems during winter, water temperature increased at a rate of `r format(winterSummary[2,]$estimate, digits = 2)`°Cyr^-1^ ± `r format(winterSummary[2,]$std.error, digits = 2)` (see also [@fig-habParams]). 

```{r}
#| label: fig-TempPlot
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 6.5
#| fig-height: 6
#| fig-cap: "Annually averaged water temperature over time. Error bars represent ± 1 standard error."

(seasonTempPlot <- ggplot(winterTemp,
                aes(x     = contYear, 
                    y     = meanTemp, 
                    group = system,
                    color = system
                )) + 
    geom_point(alpha = 0.4) +
    geom_errorbar(aes(ymin = meanTemp-seTemp, ymax = meanTemp+seTemp),
                  data = winterTemp,
                alpha = 0.4) +
    geom_point(data = summerTemp,
                alpha = 0.4) +
    geom_errorbar(aes(ymin = meanTemp-seTemp, ymax = meanTemp+seTemp),
                  data = summerTemp,
                alpha = 0.4) +
    #coord_cartesian(ylim = c(14, 23)) +
    geom_smooth(method = "lm", 
                formula = y ~ x,
                se = FALSE,
                data = winterTemp[winterTemp$system %in% c("AP", "TB", "CH"),],
                linetype = "solid") +
    geom_smooth(method = "lm", 
                formula = y ~ x,
                se = FALSE,
                data = winterTemp[winterTemp$system %in% c("CK"),],
                linetype = "solid") +
        geom_smooth(method = "lm", 
                formula = y ~ x,
                se = FALSE,
                data = summerTemp[summerTemp$system %in% c("CK", "TB", "CH"),],
                linetype = "solid") +
    geom_smooth(method = "lm", 
                formula = y ~ x,
                se = FALSE,
                data = summerTemp[summerTemp$system %in% c("AP"),],
                linetype = "solid") +
    labs(#title = "Annual Water Temperature Over Time",
      x     = "Year",
      y     = "Mean annual water temperature (°C)",
      #fill  = NULL
    ) +
    scale_color_brewer(palette = "PuOr") +
    #scale_color_viridis_d() +
    theme_bw() +
    facet_wrap(~season,
               nrow = 2,
               scales = "free_y") +
    theme(
      legend.position = "bottom"
    ))
```

ANCOVA models for average submerged aquatic vegetation coverage (SAV) identified differences in mean annual percent SAV across all systems within seasons as well as an interaction between some systems and year ([@tbl-bvcMeans]). Post-hoc analyses confirmed all systems had different average annual SAV from one another within each season (*t* ≥ `r format(as.data.frame(winterSummaryBVCAll$contrasts)$t.ratio[6], digits = 3)` for all *p* < 0.05). Specifically, Charlotte Harbor had the most coverage for both seasons ranging from `r format(winterSumBVCAll[4,]$estimate, digits = 3)`% ± `r format(winterSumBVCAll[4,]$std.error, digits = 3)` in winter to `r format(summerSumBVCAll[4,]$estimate, digits = 3)`% ± `r format(summerSumBVCAll[4,]$std.error, digits = 3)` in summer. Cedar Key averaged the lowest coverage, ranging from `r format(winterSumBVCAll[2,]$estimate, digits = 3)`% ± `r format(winterSumBVCAll[2,]$std.error, digits = 3)` in winter to `r format(summerSumBVCAll[2,]$estimate, digits = 3)`% ± `r format(summerSumBVCAll[2,]$std.error, digits = 3)` in summer. Tampa Bay and Apalachicola Bay were both in the middle of these ranges for both seasons ([@tbl-bvcMeans]). Post-hoc analyses also revealed the change in SAV coverage over time was different for Cedar Key compared to all other systems for the summer season (see also [@fig-habParams]), with a decrease in SAV at a rate of `r format(BVCsummerSlope[2,]$smallYear.trend, digits = 3)`%yr^-1^ ± `r format(BVCsummerSlope[2,]$std.error, digits = 3)` (*t* ≥ `r format(as.data.frame(summerBVCContrasts$contrasts)$t.ratio[3], digits = 3)` for all *p* < 0.05). All other system pairs were statistically similar and experienced no significant change in SAV coverage over time ([@tbl-bvcAncovaContrast-1]). Change in SAV coverage in the winter was more nuanced, where SAV in both Tampa Bay and Charlotte Harbor differed from the northern estuaries Apalachicola Bay and Cedar Key (*t* ≥ `r format(as.data.frame(winterBVCContrasts$contrasts)$t.ratio[2], digits = 3)` for all *p* < 0.05; [@tbl-bvcAncovaContrast-2]). SAV in Tampa Bay and Charlotte Harbor increased during the winter at a rate of `r format(BVCwinterSlope[3,]$smallYear.trend, digits = 3)`%yr^-1^ ± `r format(BVCwinterSlope[3,]$std.error, digits = 3)` and `r format(BVCwinterSlope[4,]$smallYear.trend, digits = 3)`%yr^-1^ ± `r format(BVCwinterSlope[4,]$std.error, digits = 3)`, respectively. Cedar Key did not have any significant change in the winter. Of note, the northernmost estuary in this study, Apalachicola Bay, did not have any significant change in SAV over the study period ([@fig-BVCPlot]).

```{r BVCPlot}
#| label: fig-BVCPlot 
#| echo: FALSE 
#| message: FALSE 
#| fig-width: 6.5 
#| fig-height: 6 
#| fig-cap: "Annually averaged SAV coverage over time. Error bars represent ± 1 standard error. Solid lines indicate significant modeled trends and dashed lines indicate a trend of no significance."

(fullBVCPlot <- ggplot(summerBVC,
                aes(x     = contYear, 
                    y     = meanBVC, 
                    group = system,
                    color = system
                )) + 
    geom_point(alpha = 0.4) +
    geom_errorbar(aes(ymin = meanBVC-seBVC, ymax = meanBVC+seBVC),
                data = summerBVC,
                alpha = 0.4) +
    geom_point(data = winterBVC,
                alpha = 0.4) +
    geom_errorbar(aes(ymin = meanBVC-seBVC, ymax = meanBVC+seBVC),
                data = winterBVC,
                alpha = 0.4) +
    coord_cartesian(ylim = c(0, 62)) +
    geom_smooth(method = "lm", 
                formula = y ~ x,
                se = FALSE,
                data = summerBVC[summerBVC$system %in% c("CK"),],
                linetype = "solid") +
    geom_smooth(method = "lm", 
                formula = y ~ x,
                se = FALSE,
                data = summerBVC[summerBVC$system %in% c("AP", "TB", "CH"),],
                linetype = "dashed") +
    geom_smooth(method = "lm", 
                formula = y ~ x,
                se = FALSE,
                data = winterBVC[winterBVC$system %in% c("TB", "CH"),],
                linetype = "solid") +
    geom_smooth(method = "lm", 
                formula = y ~ x,
                se = FALSE,
                data = winterBVC[winterBVC$system %in% c("AP", "CK"),],
                linetype = "dashed") +
    labs(#title = "Annual Water Temperature Over Time",
      x     = "Year",
      y     = "Mean annual SAV (%)",
      #fill  = NULL
    ) +
    scale_color_brewer(palette = "PuOr") +
    #scale_color_viridis_d() +
    theme_bw() +
    facet_wrap(~season,
               nrow = 2,
               scales = "free_y") +
    theme(
      legend.position = "bottom"
    ))
```

![Summary of observed habitat parameter trends per system and season. "+" indicates positive trend, "-" indicates negative trend, and "0" indicates no trend. Trend direction calculated using ANCOVA framework and significant at alpha 0.95.](conceptFigs/habParamSyn2.png){#fig-habParams}

### Community Data {#sec-community-data}

Total abundance was generally lower for all systems in the winter season (average total abundance `r format(abundStats[2,]$meanAb, digits = 2)` ±`r format(abundStats[2,]$seAb, digits = 2)`), with summer generally higher (average total abundance `r format(abundStats[1,]$meanAb, digits = 2)` ±`r format(abundStats[1,]$seAb, digits = 2)`) ([@fig-AbundPlot]).

```{r}
#| label: fig-AbundPlot
#| echo: FALSE
#| message: FALSE
#| fig-width: 6.5
#| fig-height: 4
#| fig-cap: "Mean total abundance (fourth-root transformed) over time. Error bars represent ± 1 standard error."
plot(AbundPlot_ann)
```

```{r}
#| label: GLMM output prep
#| echo: FALSE
#| message: FALSE

### abundance
abundFullS <- broom.mixed::tidy(glmmOutAbS, effects = "fixed") %>%
  select(term, estimate, std.error, p.value)
conditionS <- which(abundFullS$p.value < 0.05)

abundFullW <- broom.mixed::tidy(glmmOutAbW, effects = "fixed") %>%
  select(term, estimate, std.error, p.value)
conditionW <- which(abundFullW$p.value < 0.05)

abundContW <- emtrends(glmmOutAbW, ~ system, var = "smallYear", contr = "revpairwise")
abundMeanW <- emmeans(glmmOutAbW, spec = "system", contr = "revpairwise")

### richness
richFullS <- broom.mixed::tidy(glmmOutRS, effects = "fixed") %>%
  select(term, estimate, std.error, p.value)
conditionRS <- which(richFullS$p.value < 0.05)

richFullW <- broom.mixed::tidy(glmmOutRW, effects = "fixed") %>%
  select(term, estimate, std.error, p.value)
conditionRW <- which(richFullW$p.value < 0.05)

richMeanS <- emmeans(glmmOutRS, spec = "system", contr = "revpairwise")
richMeanW <- emmeans(glmmOutRW, spec = "system", contr = "revpairwise")

```

Results from post-hoc tests on total abundance GLMMs revealed that in summer, there was no difference in mean total abundance across all systems, with a positive correlation with SAV and no significant correlation with water temperature ([@tbl-abundModels]). In contrast, there were nuanced differences in abundances among estuaries in the winter. Specifically, Apalachicola Bay had greater abundance than all other systems and Charlotte Harbor had higher total abundance than Tampa Bay (*t* ≥ `r format(as.data.frame(abundMeanW$contrasts)$t.ratio[6], digits = 3)` for all *p* < 0.05 [@tbl-abundModels-3]). Further, results of the GLMMs indicated that abundances were positively correlated to both SAV and water temperature in winter and the magnitude of their effects were similar. The response of total abundance over time was more nuanced, with no change during the summer season, while in winter, all systems were decreasing over time, though Tampa Bay was decreasing at a slower rate than in Apalachicola Bay (*t* = `r format(as.data.frame(abundContW$contrasts)$t.ratio[2], digits = 3)` *p* = `r format(as.data.frame(abundContW$contrasts)$p.value[2], digits = 3)` [@fig-abundSyn]; see also [@tbl-abundModels-4]).

![Summary of observed biological response trends per system and season from total abundance model. Trend direction calculated using GLMM framework and significant at alpha 0.95.](conceptFigs/abundSyn.png){#fig-abundSyn}

Mean total richness ([@fig-NPlot]) in winter (`r format(nStats[2,]$meanN, digits = 2)` ±`r format(nStats[2,]$seN, digits = 2)`) was consistently lower for each estuary than in the summer (`r format(nStats[1,]$meanN, digits = 2)` ±`r format(nStats[1,]$seN, digits = 2)`).

```{r}
#| label: fig-NPlot
#| echo: FALSE
#| message: FALSE
#| fig-width: 6.5
#| fig-height: 4
#| fig-cap: "Mean total richness over time. Error bars represent ± 1 standard error."
plot(NPlot_ann)
```

Results from post-hoc tests on total richness GLMMs indicated modeled average richness of Apalachicola Bay in summer was greater than all other estuaries, with no significant difference in means among the other three (*t* ≥ `r format(abs(as.data.frame(richMeanS$contrasts)$t.ratio[1]), digits = 3)` for all *p* < 0.05 [@tbl-richModels-3]). In winter, modeled average richness was more nuanced, where Charlotte Harbor had the highest modeled richness compared to all other estuaries, Tampa Bay had higher than Cedar Key, and Cedar Key had less than Apalachicola Bay (*t* ≥ `r format(abs(as.data.frame(richMeanW$contrasts)$t.ratio[1]), digits = 3)` for all *p* < 0.05 [@tbl-richModels-4]). Further, results of the GLMMs indicated that total richness was positively correlated with SAV for all systems and seasons. As with total abundance, water temperature was not significant in any estuaries during the summer but was again positively associated with total richness in all estuaries in winter ([@tbl-richModels]). However, the relative magnitude of the effect of SAV compared to the effect of water temperature on richness was greater than it was in the abundance models. Further, total richness had no discernible trends over time in any of the estuaries or seasons ([@fig-richSyn]).

![Summary of observed biological response trends per system and season from total richness model. Trend direction calculated using GLMM framework and significant at alpha 0.95.](conceptFigs/richSyn.png){#fig-richSyn}

```{r}
#| label: BetaDiversity
#| include: FALSE
#| cache: TRUE
source("BetadiversityPairwise.R")

overallBeta <- betaTimeDF %>%
  filter(Index == "Overall")

#pairwise emmeans
betaWinterSummaryAll <- lsmeans(betaWinterLm, spec = "system", contr = "revpairwise")
betaSummerSummaryAll <- lsmeans(betaSummerLm, spec = "system", contr = "revpairwise")

betaWinterSumAll <- tidy(betaWinterSummaryAll$lsmeans)
betaSummerSumAll <- tidy(betaSummerSummaryAll$lsmeans)

#pairwise slope checks
betaWinterContrasts <- lstrends(betaWinterLm, ~ system, var = "smallYear", contr = "revpairwise")
betaSummerContrasts <- lstrends(betaSummerLm, ~ system, var = "smallYear", contr = "revpairwise")

betaWinterSlope <- tidy(betaWinterContrasts$lstrends)
betaSummerSlope <- tidy(betaSummerContrasts$lstrends)

betaWinterContSlope <- tidy(betaWinterContrasts$contrasts)
betaSummerContSlope <- tidy(betaSummerContrasts$contrasts)

betaWinterSummary <- tidy(summary.lm(betaWinterLm))
betaSummerSummary <- tidy(summary.lm(betaSummerLm))
```

ANCOVA models of Bray-Curtis dissimilarity pairwise over time revealed a general trend of stability during the summer with no significant change over time among any of the estuaries. However, during winter, there was a trend of increasing dissimilarity through time for all estuaries ([@tbl-betaModels]). In addition, during winter, particularly in the northern estuaries (Apalachicola Bay and Cedar Key), there was considerably higher variability in the years after 2010 ([@fig-betadiversity]). Within dissimilarity overall, there were clear variations in the underlying components of betadiversity (turnover and nestedness), though they are not modeled here.

```{r}
#| label: fig-betadiversity
#| echo: FALSE
#| message: FALSE
#| fig-width: 6.5
#| fig-height: 5
#| fig-cap: "Partitioned betadiversity calculated pairwise with respect to the first year of available data. Balanced represents turnover and gradient represents nestedness."

(betaTimePlot <- ggplot(aes(x = contYear,
                            y = value,
                            color = Index),
                        data = betaTimeDF) +
  geom_line(
    linewidth = 0.7) +
  facet_grid(season~system) +
  # scale_x_continuous(breaks= seq(1998,2020,5)) +
  # scale_color_cmocean(discrete = TRUE,
  #                     name = "solar") +
  # scale_color_viridis_d(option = "viridis") +
    geom_smooth(method = "lm",
                formula = y ~ x,
                se = FALSE,
                data = overallBeta[overallBeta$season %in% c("Summer"),],
                linetype = "dashed") +
       geom_smooth(method = "lm",
                formula = y ~ x,
                se = FALSE,
                data = overallBeta[overallBeta$season %in% c("Winter"),],
                linetype = "solid") +
  scale_color_brewer(palette = "Set1") +
  labs(#title = "Abundance-based dissimilarity over time",
       x = "Year",
       y = "Betadiversity index") +
  theme_bw() +
  theme(legend.position="bottom"))
```

### Multivariate Analyses {#sec-constrained-analyses}

```{r}
#| label: RDA
#| include: FALSE
load("./Outputs/RDAsforAll_Z.RData")
load('SXS_filtered.Rdata')
RDAsforAll <- RDAsforAll_Z

systemSeason_list <- SXS_filtered %>%
  select(systemSeason) %>%
  distinct()

# perms <- list()
# stageZero <- list()
# for(i in systemSeason_list$systemSeason){
#   print(i)
#   perms[[i]] <- permutest(x = RDAsforAll[[i]]$rda, permutations = 999, parallel = 4)
#   #stageZero[[i]] <- tidy(perms[[i]])
# }

RDAaxesVar <- list()
plotsforAll <- list()
#rdaVecslist <- list()
for(i in systemSeason_list$systemSeason){
 print(i)
  mult <- 1
  mult_vec <- 1
  scores_sites <- data.frame(RDAsforAll[[i]]$scores$sites)
  vecs <- data.frame(RDAsforAll[[i]]$env$vectors$arrows)
  #rdaVecslist[[i]] <- vecs
  middles <- data.frame(RDAsforAll[[i]]$scores$centroids)
  plotSub <- SXS_filtered %>% #filter out systemSeason of interest just as in rda loop (df_env)
    filter(systemSeason %in% i) %>%
    select(seasonYear) %>%
    cbind(scores_sites) %>%
    group_by(seasonYear) %>%
    summarise(across(everything(), ~ mean(.x, na.rm = TRUE)))
  # grps <- data.frame(rownames(middles) %>%
  #   str_remove_all("seasonYear")) %>%
  #   rename(seasonYear = rownames.middles......str_remove_all..seasonYear..)
  
  plotsforAll[[i]] <- ggplot(plotSub) +
    geom_vline(xintercept = 0,
               colour     = "grey70",
               size       = 1) +
    geom_hline(yintercept = 0,
               colour     = "grey70",
               size       = 1) +
    scale_x_continuous(limits       = symmetric_range,
                       breaks       = c(-6,-1,0,1,6),
                       minor_breaks = NULL) +
    scale_y_continuous(limits       = symmetric_range,
                       breaks       = c(-6,-1,0,1,6),
                       minor_breaks = NULL) +
    labs(title = paste0(i, " ", round((RsquareAdj(RDAsforAll[[i]]$rda)$adj.r.squared*100), 2), "%"), 
         x     = paste("CA1 (", round(100*RDAsforAll[[i]]$rda$CCA$eig[1]/RDAsforAll[[i]]$rda$tot.chi,2), "%)", sep = ""),
         y     = paste("CA1 (", round(100*RDAsforAll[[i]]$rda$CCA$eig[2]/RDAsforAll[[i]]$rda$tot.chi,2), "%)", sep = ""))+
    scale_color_manual(values = c("blue","darkgreen"),
                       guide  = guide_none()) +
    # geom_point(data = scores_sites,
    #            aes(x = mult*dbRDA1,
    #                y = mult*dbRDA2,
    #            ),
    #            size   = 1,
    #            stroke = 0.1,
    #            pch    = 21,
    #            colour = "black") +
    geom_point(aes(x = mult*dbRDA1,
                   y = mult*dbRDA2,
                   fill = as.numeric(as.character(seasonYear))),
               size   = 4,
               stroke = 0.1,
               pch    = 21,
               colour = "black") +
    scale_fill_gradient(
      low = "blue",
      high = "red",
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    ) +
    theme_bw() +
    theme(legend.text       = element_text(size=rel(0.8)),
          legend.position   = c(0.055,0.89),
          legend.background = element_blank(),
          legend.key        = element_blank(),
          panel.grid        = element_blank()) +
    geom_segment(data = vecs,
                 aes(x     = 0, 
                     xend  = mult_vec*dbRDA1, 
                     y     = 0, 
                     yend  = mult_vec*dbRDA2, 
                     #color = "blue"
                       ),
                 arrow = arrow(length = unit(.1,"inches")),
                 size  = 1,
                 alpha = 0.6) +
    geom_label_repel(data = vecs,
                     aes(x      = mult_vec*dbRDA1,
                         y      = mult_vec*dbRDA2,
                         label  = rownames(vecs),
                         #colour = "blue",
                         #size   = "blue"
                           ),
                     force         = 0.1,
                     alpha         = 0.8,
                     fontface      = "bold",
                     label.padding = 0.25,
                     box.padding   = 0.1,
                     fill          ="white",
                     label.r       = 0.25,
                     label.size    = 0.25,
                     segment.alpha =0,
                     nudge_x       = ifelse(vecs$dbRDA1>0,0.1,-0.1),
                     nudge_y       = ifelse(vecs$dbRDA2>0,0.2,-0.2)) +
    scale_size_manual(values = c(2.5,3.5),
                      guide  = guide_none()) +
    guides(fill = guide_legend(override.aes = list(size = 2.5),
                               keyheight    = 0.15,
                               keywidth     = 0.2,
                               title = "Year"))
  
  RDAaxesVar[[i]]$CA1 <- round(100*RDAsforAll[[i]]$rda$CCA$eig[1]/RDAsforAll[[i]]$rda$tot.chi,2)
  RDAaxesVar[[i]]$CA2 <- round(100*RDAsforAll[[i]]$rda$CCA$eig[2]/RDAsforAll[[i]]$rda$tot.chi,2)
  RDAaxesVar[[i]]$fullModel <- round((RsquareAdj(RDAsforAll[[i]]$rda)$adj.r.squared*100), 2)
}

fullRDAPlot <- wrap_plots(plotsforAll,
                      ncol = 2)

RDAaxes <- bind_rows(RDAaxesVar, .id = "systemSeason")
```

Results of the PERMANOVAs indicated a significant interaction between year and estuary for both seasons and so separate CAP models were conducted for each system within season ([@tbl-fullPERMANOVA]).

```{r}
#| label: PERMANOVA
#| include: FALSE
load("bigPERMANOVAs.RData")
```

```{r}
#| label: tbl-fullPERMANOVA
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Summary outputs from PERMANOVAs conducted for each season. Values in bold are significant."
#| tbl-subcap:
#|   - "Summer"
#|   - "Winter"

emphasize.strong.cells(which(summerfAbundPERM < 0.05, arr.ind = TRUE))
pander(summerfAbundPERM)

emphasize.strong.cells(which(winterfAbundPERM < 0.05, arr.ind = TRUE))
pander(winterfAbundPERM)

```

```{r}
#| label: CAP_processing
#| include: FALSE
load("./Outputs/CAPsforAll_Z_infm.RData")

#source https://github.com/jonpeake/forage-fish-public-code/blob/main/ForageFigures_CODE.R
cap_pctvars <- function(cap_out){
  # A function that takes the output of the CAPdiscrim function and 
  # produces the percent of among-group variability explained by each
  # canonical axis.
  #
  # Inputs: 
  # cap_out = 'CAPDiscrim' function list output
  # 
  # Output: 
  # pct_var = A numerical array with dimensions 1 x p, where p is the
  #           number of canonical axes, corresponding to the percent
  #           of among-group variability explained by each axis.
  #         
  
  # Extract eigenvalues from manova sublist
  eig     <- cap_out[["manova"]][["Eigenvalues"]]
  
  # Convert eigenvalues to analog of canonical variability
  vars    <- eig*cap_out$tot*(cap_out$varm/100)/(eig+1)
  
  # Calculate percent of variability explained by each axis
  pct_var <- t(100*vars/sum(vars))
  
  # Trim rows not corresponding to canonical axes
  pct_var <- pct_var[1:ncol(cap_out$x),]
  return(pct_var)
}

load('TidyGearCode20.Rdata')
load('SXS_filtered.Rdata')

#data setup
#build month dataframe
monthly <- HydroList %>%
  select(Reference, month)

#rejoin with environmental data
SXS_run_env <- SXS_filtered_env %>%
  #left_join(SXS_filtered_env) %>%
  left_join(monthly) %>%
  group_by(systemSeason) %>%
  add_count(name = "n_hauls") %>% #count number of hauls per systemSeason
  ungroup() %>%
  group_by(systemSeason, seasonYear) %>%
  mutate(avg_temp = mean(Temperature, na.rm = TRUE),
         n_temp = n(),
         upper = quantile(Temperature, 0.9),
         lower = quantile(Temperature, 0.1),
         sd_ann = sd(Temperature)) %>%
  ungroup() %>%
  group_by(systemSeason) %>%
  mutate(avg_ltm = mean(avg_temp),
         sd_ltm = sd(avg_temp, na.rm = TRUE),
         upper_sd = sd(upper),
         lower_sd = sd(lower)) %>%
  mutate(anom_temp = avg_temp - avg_ltm,
         se_temp = sd_ltm/sqrt(n_temp),
         lower.ci.anom.temp = 0 - (1.96 * se_temp),
         upper.ci.anom.temp = 0 + (1.96 * se_temp)) %>%
  #zscoreing
  mutate(bvc_ltm  = mean(BottomVegCover, na.rm = TRUE),
         bvc_sd   = sd(BottomVegCover, na.rm = TRUE),
         temp_ltm = mean(Temperature, na.rm = TRUE),
         temp_sd  = sd(Temperature, na.rm = TRUE),
         year_ltm = mean(as.numeric(as.character(seasonYear)), na.rm = TRUE),
         year_sd  = sd(as.numeric(as.character(seasonYear)), na.rm = TRUE),
         bvc_Z    = ((BottomVegCover - bvc_ltm)/bvc_sd),
         temp_Z   = ((Temperature - temp_ltm)/temp_sd),
         year_Z    = ((as.numeric(as.character(seasonYear)) - year_ltm)/year_sd),
         sd_t_Z   = sd(temp_Z)) %>%
  #monthly
  ungroup() %>%
  group_by(systemSeason, seasonYear, month) %>%
  mutate(avg_temp_mon = mean(Temperature, na.rm = TRUE),
         n_temp_mon = n(),
         upper_mon = quantile(Temperature, 0.9),
         lower_mon = quantile(Temperature, 0.1),
         upper_Z  = quantile(temp_Z, 0.9),
         lower_Z  = quantile(temp_Z, 0.1),
         sd_mon = sd(Temperature),
         se_mon = sd_mon/sqrt(n_temp_mon))

systemSeason_list <- SXS_filtered %>%
  select(systemSeason) %>%
  distinct()

### centroids ####
for(i in systemSeason_list$systemSeason){
  df <- SXS_filtered %>% #filter out systemSeason of interest
    filter(systemSeason %in% i)
  
  df_spe_filtered <- SXS_filtered %>%
    filter(Reference %in% df$Reference) %>%
    subset(select = -c(systemSeason, seasonYear, Reference, systemZone, BottomVegCover, Temperature)) %>%
    select(which(!colSums(., na.rm=TRUE) %in% 0)) #select only taxa present in this systemSeason
  
  df_env <- data.frame(SXS_run_env %>% #pull out environmental variables
                         filter(Reference %in% df$Reference) %>%
                         subset(select = c(systemSeason, seasonYear, bvc_Z, temp_Z)) %>%
                         mutate(contYear = as.numeric(as.character(seasonYear))))

CAPsforAll[[i]]$centroids <- centroids.long(sites.long(ordiplot(CAPsforAll[[i]])),
                                            df_env$seasonYear,
                                            centroids.only = TRUE)
}

##### centroids with sppvec plots #######
#need fixed range of sppvecs first
sppvecs_list <- list()
sppvecs_list_fix <- list()
for(i in systemSeason_list$systemSeason){
spp_vecs <- data.frame(CAPsforAll[[i]]$cproj) %>%
  #arrange(desc(abs(LD1))) %>%
  mutate(mag = sqrt(LD1^2 + LD2^2)) %>%
  arrange(desc(abs(mag))) %>%
  mutate(Scientificname = rownames(.)) %>%
  #select(system, season, Scientificname, mag)
  slice_head(n = 10)
sppvecs_list_fix[[i]] <- spp_vecs
}
sppvecs_list_fixdf <- bind_rows(sppvecs_list_fix, .id = "systemSeason")

#spp_vecs_label <- list()
#centroidPlots <- list()
mainframe <- list()
for(i in systemSeason_list$systemSeason){
  print(i) #watch progress through list
  
  centers <- data.frame(CAPsforAll[[i]]$centroids)
  
  taxa <- sppvecs_list_fixdf %>%
    filter(systemSeason == i) %>%
    mutate(mag = sqrt(LD1^2 + LD2^2)) %>%
    arrange(desc(abs(mag))) %>%
    #select(system, season, Scientificname, mag)
    slice_head(n = 3)
  
  interim <- data.frame(LD1var = round(cap_pctvars(CAPsforAll[[i]]), 2)[1],
                        LD2var = round(cap_pctvars(CAPsforAll[[i]]), 2)[2],
                        allVar = round(CAPsforAll[[i]]$percent, 2),
                        axis1c = centers$axis1c,
                        axis2c = centers$axis2c,
                        df_env.seasonYear = centers$df_env.seasonYear,
                        topTaxLD1 = taxa[1,2],
                        topTaxLD2 = taxa[1,3],
                        topTaxNam = taxa$Scientificname[1],
                        twoTaxLD1 = taxa[2,2],
                        twoTaxLD2 = taxa[2,3],
                        twoTaxNam = taxa$Scientificname[2],
                        thrTaxLD1 = taxa[1,2],
                        thrTaxLD2 = taxa[1,3],
                        thrTaxNam = taxa$Scientificname[3])
  
  mainframe[[i]] <- interim
}

centroidDf <- bind_rows(mainframe, .id = "systemSeason")

stageOne <- sppvecs_list_fixdf %>%
  select(systemSeason, Scientificname, LD1, LD2) %>%
  ungroup() %>%
  group_by(systemSeason) %>%
  slice_head(n = 3)

mult <- 3

centroidPlots <- list()
for(i in systemSeason_list$systemSeason){
  indf <- centroidDf %>%
    filter(systemSeason == i)
  
  taxdf <- stageOne %>%
    filter(systemSeason == i)
  
  centroidPlots[[i]] <- ggplot(indf) +
        geom_vline(xintercept = 0,
               colour     = "grey70",
               size       = .25) +
    geom_hline(yintercept = 0,
               colour     = "grey70",
               size       = .25) +
    scale_x_continuous(limits       = symmetric_range(1+(mult)*sppvecs_list_fixdf$LD1),
                       breaks       = c(-6,-3,0,3,6),
                       minor_breaks = NULL) +
    scale_y_continuous(limits       = symmetric_range(1+(mult)*sppvecs_list_fixdf$LD2),
                       breaks       = c(-6,-3,0,3,6),
                       minor_breaks = NULL) +
    geom_point(aes(x    = axis1c, 
                   y    = axis2c, 
                   fill = as.numeric(as.character(df_env.seasonYear))),
               size   = 4, 
               stroke = 0.1,
               pch    = 21, 
               colour = "black") +
    labs(title = paste0(i, " ", round(indf$allVar[1], 2), "%"),
         x     = paste("CA1 (",indf$LD1var[1],"%)",sep=""),
         y     = paste("CA2 (",indf$LD2var[1],"%)",sep=""),
         fill  = NULL) +
    scale_fill_gradient(
      low = "blue",
      high = "red",
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    ) +
    theme_bw() +
    theme(legend.text       = element_text(size=rel(0.8)),
          legend.position   = c(0.055,0.89),
          legend.background = element_blank(),
          legend.key        = element_blank(),
          panel.grid        = element_blank()) +
    geom_segment(data = taxdf,
                 aes(x    = 0,
                     xend = mult*LD1,
                     y    = 0,
                     yend = mult*LD2),
                 arrow = arrow(length = unit(0.1,"inches")),
                 color = "grey1",
                 size  = .75,
                 alpha = 0.6) +
  geom_label_repel(data = taxdf,
                   aes(x     = mult*LD1 + 0.2*cos(atan(LD2/LD1))*sign(LD1),
                       y     = mult*LD2 + 0.2*sin(atan(LD2/LD1))*sign(LD2),
                       label = Scientificname),
                   segment.alpha = 0,
                   size          = 3.25,
                   color         = "blue",
                   fontface      = "bold",
                   fill          = "white",
                   alpha         = 0.7,
                   box.padding   = .25,
                   lineheight    = 0.4,
                   label.size    = 0.25,
                   #nudge_x       = ifelse(spp_vecs_label[[i]]$LD1>0,0.05,-0.05),
                   #nudge_y       = ifelse(spp_vecs_label[[i]]$LD2>-0.02,0.05,-0.05),
                   force         = 0.3) +
  guides(fill = guide_legend(override.aes = list(size = 2.5),
                             keyheight    = 0.15,
                             keywidth     = 0.2))
    
}
    
    centroidCAP <- wrap_plots(centroidPlots,
           ncol = 2)
    
# table assembly
spp_vec_setup <- list()
for(i in systemSeason_list$systemSeason){
xf <- data.frame(CAPsforAll[[i]]$cproj) %>%
  arrange(desc(abs(LD1))) %>%
  slice_head(n = 5) %>%
  mutate(Scientificname = row.names(.)) %>%
  pivot_longer(cols = starts_with("LD"), names_to = "axisVar") %>%
  filter(axisVar %in% c("LD1", "LD2")) %>%
  mutate(systemSeason = i) %>%
  mutate(percent = CAPsforAll[[i]]$percent) %>%
  separate(systemSeason,
           c("system","season"),
           sep = "_")

spp_vec_setup[[i]] <- xf
}
topSpp <- bind_rows(spp_vec_setup)

sysSpp <- topSpp %>%
  group_by(system, season) %>%
  filter(axisVar %in% c("LD1","LD2")) %>%
  pivot_wider(names_from = axisVar) %>%
  mutate(mag = sqrt(LD1^2 + LD2^2)) %>%
  filter(mag == max(mag)) %>%
  select(system, season, Scientificname, mag)

confuseM <- list()
for(i in systemSeason_list$systemSeason){
  group <- data.frame()
     CV <- data.frame()
     
     group <- CAPsforAll[[i]]$group
     CV <- CAPsforAll[[i]]$CV
     
 confuseM[[i]]  <- caret::confusionMatrix(data = CV, reference = group)
}

```

Visual assessment of the CAP ordinations suggested variability in assemblage composition and abundance over time, as indicated by subtle shifts of the yearly centroids. For most systems, this was gradual, but Cedar Key summer appeared to have a distinct separation of two groups of years on the first axis of variation ([@fig-centroidCAP]). Only five taxa were selected as the top associated with year separation on the first two canonical axes (see [@tbl-CAPtaxa]). The range of variability described by the CAP models was `r paste0(round(min(topSpp$percent),2), "%")` to `r paste0(round(max(topSpp$percent),2), "%")`.

```{r}
#| label: tbl-CAPtaxa
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Taxon with the greatest magnitude vector as measured on the first two axes of variation."
pander(sysSpp)
```

```{r}
#| label: fig-centroidCAP
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 6.5
#| fig-height: 8
#| fig-cap: "Canonical analysis of principal coordinates ordination plots. Shading of markers indicates year for that group, with blue markers indicating centroids of the oldest years in the data and red indicating the most recent years. Percentages next to subplot title indicate total variability captured by the model. Top three taxa associated with canonical axes scores plotted as vectors. Canonical axis (CA) percentages indicate the among-group variation captured in each axis."

plot(centroidCAP)
```

In multivariate species-spaces, dbRDA confirmed the significance of SAV and water temperature in describing the variation in betadiversity across all systems and seasons when compared to a null model ([@fig-RDAforAll]). The range of variation explained by the models was `r min(RDAaxes$fullModel)`% to `r max(RDAaxes$fullModel)`%. The range of variation of explained by the first canonical axis of each model was `r min(RDAaxes$CA1)`% to `r max(RDAaxes$CA1)`% within the overall model variaton, with the range of the second canonical axis as `r min(RDAaxes$CA2)`% to `r max(RDAaxes$CA2)`%. No clear patterns of separation among groups of year were apparent in the different ordinations. Across estuaries, Cedar Key and Charlotte Harbor appear to have the most tightly clustered yearly centroids compared to Apalachicola Bay and Tampa Bay.

```{r}
#| label: fig-RDAforAll
#| echo: FALSE
#| message: FALSE
#| fig-width: 6.5
#| fig-height: 8
#| fig-cap: "Distance-based redundancy analysis (dbRDA) ordination to visualize effects of habitat parameters. Shading of markers indicates year for that group, with blue markers indicating centroids of the oldest years in the data and red indicating the most recent years. Canonical axis (CA) percentages indicate the total variation in estuarine communities explained by that axis. Each habitat variable is represented by vectors and centroids of taxa groups are calculated using weighted average scores."

plot(fullRDAPlot)
```

### Individual Taxon Analyses {#sec-univariate-analyses}

The majority of taxa did not exhibit significant changes in abundance over time, with a large group centered around zero in both summer and winter ([@fig-winnersLosers]). Overall, the number of taxa changing negatively was different between winter and summer across all systems (*t* = `r format(sigSig$statistic, digits = 3)`, *p* = `r format(sigSig$p.value, digits = 3)`; see [@tbl-sigTaxa]). In comparison, there was no difference in positively changing taxa across season.

```{r}
#| label: tbl-sigTaxa
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| tbl-cap: "Summary of counts of taxa with significant changes in abundance over time."

pander(sigSummaryShort)
```

```{r}
#| label: fig-winnersLosers
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 6.5
#| fig-height: 5
#| fig-cap: "Density plots of slopes of taxa abundance over time. Dashed line indicates a slope of 0."

winnersLosers
```

Plotting the taxonomic groups of each significant taxa reveals the magnitude of change in boney fishes is considerably greater than in all other groups. In Cedar Key summer, there is an exception where the greatest change is observed in a shrimp species ([@fig-sigSlopes_grouped]).

```{r}
#| label: fig-sigSlopes_grouped
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 6.5
#| fig-height: 5
#| fig-cap: "Taxonomically-grouped slopes of abundance over time plotted per estuary and season. Red indicates a negative change over time and blue indicates a positive change. The dashed line represents a slope of 0."

sigSlopesGroups
```

The majority of taxa that had statistically significant slopes still experienced rather modest changes in abundance while a few taxa had slopes an order of magnitude greater than the majority, ranging from an absolute magnitude of `r format(minSpSlope$raw_slope, digits = 2)` to `r round(max(abs(sigSlopes$raw_slope)), 2)` ([@fig-sigSlopes]).

```{r}
#| label: fig-sigSlopes
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 6.5
#| fig-height: 9
#| fig-cap: "Slopes of taxa abundance over time plotted per estuary and season. Red indicates a negative change over time and blue indicates a positive change. The dashed line represents a slope of 0."

#sigSlopesAll

#get unique list for the loop
seasysKey <- unique(sigSlopes$systemSeason)

sigPlotsFree <- list()
for (i in seasysKey){
  #print(i)
  gf <- sigSlopes_grouped %>%
    filter(systemSeason == i)
  
  sigPlotsFree[[i]] <- ggplot(gf,
         aes(y = reorder(Scientificname, raw_slope),
             x = raw_slope)) + 
    geom_point(aes(color = as.factor(id_color))) +
    scale_color_manual(values = c("red","blue")) +
    facet_wrap(~ systemSeason,
               ncol = 2) +
    geom_errorbarh(aes(xmin=(raw_slope + (-2*stderr)), xmax=(raw_slope + (2*stderr))),
                   color = "darkgray") + #std err bars
    scale_x_continuous(trans = pseudolog10_trans) +
    #ggtitle("Change in density over time by group") + 
    theme_bw() +
    theme(legend.position = "none",
          axis.title.y = element_blank(),
          axis.title.x = element_blank()
    ) +
    #coord_cartesian(xlim = c(-.2, 0.2)) +
    geom_vline(xintercept = 0, linetype="dashed")
}

(sigSlopesAllFree <- wrap_plots(sigPlotsFree, ncol = 2))

```

The majority of taxa that changed over time were either subtropical/tropical-associated or subtropical/tropical/temperate-associated ([@fig-ecoSlopes]).

```{r}
#| label: fig-ecoSlopes
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 6.5
#| fig-height: 9
#| fig-cap: "Slopes of taxa abundance over time plotted per estuary and season. Red indicates a negative change over time and blue indicates a positive change. The dashed line represents a slope of 0. Climatological association is represented by the symbol shape. Note: not all climatalogical associations for all taxa were available and thus some are not displayed."

# intEco <- wrap_plots(plotsEco, ncol = 2, guides = "collect") &
#   labs() & theme(plot.margin = margin(5.5, 5.5, 0, 5.5)) & theme(legend.position = 'bottom')
# 
# # Use the tag label as an x-axis label
# outEco <- wrap_elements(panel = intEco) +
#   labs(tag = "Raw slope of abundance change") +
#   theme(
#     plot.tag = element_text(size = rel(1)),
#     plot.tag.position = "bottom"
#   )
# 
# outEco

finalEco
```

# Discussion {#sec-discussion}

# Conclusion {#sec-conclusion}

# Supplemental Materials {#sec-supplemental-materials .appendix}

. . . Water temperature ANCOVA

```{r}
#| label: tbl-tempAncova 
#| echo: FALSE 
#| message: FALSE 
#| tbl-cap: "Outputs of temperature ANOCVA models." 
#| tbl-subcap: 
#|   - "summer"
#|   - "winter"

pander(summerSummary)
pander(winterSummary)

```

Water temperature contrasts from ANCOVA

```{r}
#| label: tbl-tempAncovaContrast 
#| echo: FALSE 
#| message: FALSE 
#| tbl-cap: "Contrasts from ANCOVA models. Tukey method applied for p-value correction." 
#| tbl-subcap: 
#|   - "summer"
#|   - "winter"
#|   
pander(summary(summerSummaryAll$contrasts))
pander(summary(winterSummaryAll$contrasts))

```

SAV ANCOVA outputs

```{r}
#| label: tbl-bvcAncova 
#| echo: FALSE 
#| message: FALSE 
#| tbl-cap: "Outputs of SAV ANCOVA models." 
#| tbl-subcap: 
#|   - "summer"
#|   - "winter"
pander(summerBVCSummary)
pander(winterBVCSummary)

```

SAV ANCOVA calculated means

```{r}
#| label: tbl-bvcMeans 
#| echo: FALSE 
#| message: FALSE 
#| tbl-cap: "Least square means of each system for both seasonal linear models." 

bvcMeans <- summerSumBVCAll  %>%
  mutate(season = "summer") %>%
  full_join(winterSumBVCAll) %>%
  mutate(season = ifelse(!is.na(season), "summer", "winter")) %>%
  select(system, season, estimate, std.error) %>%
  mutate(std.error = format(std.error, digits = 3))

pander(bvcMeans)
```

SAV ANCOVA contrasts

```{r}
#| label: tbl-bvcAncovaContrast 
#| echo: FALSE 
#| message: FALSE 
#| tbl-cap: "Contrasts from ANCOVA models. Tukey method applied for p-value correction." 
#| tbl-subcap: 
#|   - "summer cont"
#|   - "winter cont"
pander(tidy(summerBVCContrasts$contrasts) %>%
         select(!c(term, null.value)))
pander(tidy(winterBVCContrasts$contrasts) %>%
         select(!c(term, null.value)))
#pander(tidy(winterBVCContrasts$lstrends))

#pander(tidy(summerBVCContrasts$lstrends))
```

ABUNDANCE GLMMs

```{r}
#| label: tbl-abundModels
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Outputs of fixed effects from total abundance GLMMs run within each estuary. Bolded values are significant at alpha 0.05."
#| tbl-subcap: 
#|   - "summer"
#|   - "winter"
#|   - "winterMeans"
#|   - "winterTrends"

emphasize.strong.rows(conditionS)
pander(abundFullS)
emphasize.strong.rows(conditionW)
pander(abundFullW)
pander(tidy(abundMeanW$contrasts) %>%
         select(!c(term, null.value)))
pander(tidy(abundContW$contrasts) %>%
         select(!c(term, null.value)))

```

RICHNESS MODEL OUTPUTS

```{r}
#| label: tbl-richModels
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Outputs of fixed effects from total richness GLMMs run within each estuary. Bolded values are significant at alpha 0.05."
#| tbl-subcap: 
#|   - "summer"
#|   - "winter"
#|   - "summerMeans"
#|   - "winterMeans"

emphasize.strong.rows(conditionRS)
pander(richFullS)
emphasize.strong.rows(conditionRW)
pander(richFullW)
pander(tidy(richMeanS$contrasts) %>%
         select(!c(term, null.value)))
pander(tidy(richMeanW$contrasts) %>%
         select(!c(term, null.value)))
```

Betadiversity model outputs

```{r}
#| label: tbl-betaModels 
#| echo: FALSE 
#| message: FALSE 
#| tbl-cap: "Outputs of ANCOVA models for betadiversity." 
#| tbl-subcap:
#|   - "Summer"
#|   - "Winter"

conditionbetaS <- which(betaSummerSummary$p.value < 0.05)
conditionbetaW <- which(betaWinterSummary$p.value < 0.05)
emphasize.strong.rows(conditionbetaS)
pander(betaSummerSummary)
emphasize.strong.rows(conditionbetaW) 
pander(betaWinterSummary)

```

```{r}
#| label: CK postTest
#| include: FALSE
#| cache: TRUE
source("CKpostTest.R")
```

Post analysis of Cedar Key summer biodiversity data included a factor identifying the separation observed in the CAP model. Visual inspection indicated the earlier group as bounded by 2001 to 2010 (inclusive) ([@fig-CK_summerCAP]). PERMANOVA indicated the earlier years are indeed significantly different than the later years (*F*-ratio `r format(as.data.frame(postTest)$F[1], digits = 4)` *p* < 0.001 [@tbl-CKpost]).

```{r}
#| label: tbl-CKpost
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Post analysis using PERMANOVA informed by CAP on Cedar Key summer abundance data."
pander(postTest)
```

```{r}
#| label: fig-CK_summerCAP
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 5
#| fig-height: 5
#| fig-cap: "Canonical analysis of principal coordinates ordination plot. Shading of markers indicates year for that group, with red markers indicating centroids of the oldest years in the data and blue indicating the most recent years. Percentages next to subplot title indicate total variability captured by the model. Top three taxa associated with canonical axes scores plotted as vectors. Canonical axis (CA) percentages indicate the among-group variation captured in each axis."

plot(centroidPlots$CK_summer)
```


. . . ARCHIVAL OLD MATERIALS; NEEDS VETTED

```{r}
#| label: tbl-tempModels
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Output of water temperature linear models."
#| tbl-subcap:
#|   - "Winter"
#|   - "Summer"


emphasize.strong.cells(which(winterSummary < 0.05, arr.ind = TRUE))
pander(winterSummary)
emphasize.strong.cells(which(summerSummary < 0.05, arr.ind = TRUE))
pander(summerSummary)
```

water temp output

```{r}
#| label: tbl-tempMeans 
#| echo: FALSE 
#| message: FALSE 
#| tbl-cap: "Least square means of each system for both seasonal linear models. P-values for pairwise contrasts used tukey method for correction." 

tempMeans <- winterSumAll %>%
  mutate(season = "winter") %>%
  full_join(summerSumAll) %>%
  mutate(season = ifelse(!is.na(season), "winter", "summer")) %>%
  select(system, season, estimate, std.error) %>%
  mutate(std.error = format(std.error, digits = 3))

pander(tempMeans)
```

```{r}
#| label: tbl-bvcModels 
#| echo: FALSE 
#| message: FALSE 
#| tbl-cap: "Coefficients of year on linear models run within each estuary. Bolded values are significant at alpha 0.05." 
#| tbl-subcap:
#|   - "Winter"
#|   - "Summer"
emphasize.strong.cells(which(winterBVCSummary < 0.05, arr.ind = TRUE)) 
pander(winterBVCSummary)
emphasize.strong.cells(which(summerBVCSummary < 0.05, arr.ind = TRUE)) 
pander(summerBVCSummary)
```

```{r}
#| label: NMDS
#| include: FALSE
#| cache: TRUE
source("NMDS_annual.R")
```

NMDS reveals distinct separation among northern and southern estuaries in multivariate species-space. Using an `envfit` model, water temperature and BVC are best aligned with the distance between the two groups of estuaries ([@fig-NMDS_all]). Specifically, temperature predominantly separates the northern and southern groups (NMDS1), with BVC associated with differences among northern and southern groups (NMDS2).

```{r}
#| label: fig-NMDS_all
#| layout-nrow: 2
#| echo: FALSE
#| message: FALSE
#| warning: FALSE
#| fig-width: 6.5
#| fig-height: 5
#| fig-cap: "NMDS plots based on annual average abundance (transformed) data. Ellipses represent 95% confidence of location of centroid of each system. Individual taxa annual abundances (grey circles) are plotted as weighted average scores. Best fit of environmental parameters plotted as grey vectors and labeled."
#| fig-subcap: 
#|   - "Summer"
#|   - "Winter"
plot(summerNMDS)
plot(winterNMDS)
```

Looking closer at temp, specifically as in [@Miner2021], the upper and lower 10th percentiles of temp are sometimes changing. Mostly in winter, though not significant using linear models alone ([@fig-upperLower]). Follow-up with GLMM and model selection using AIC to determine whether upper or lower percentile was significant resulted in changes in base model structure, namely dropping the offset term and sometimes dropping BVC or temperature.

```{r}
#| label: fig-upperLower
#| echo: FALSE
#| message: FALSE
#| fig-width: 6.5
#| fig-height: 5
#| fig-cap: "Temperature extremes."
plot(annualTemp)
```

Slopes of all significantly changing taxa:

```{r}
#| label: tbl-sigSlopesAll
#| echo: FALSE
#| message: FALSE
#| tbl-cap: "Taxa identified as having a signficant slope in abundance over time."
#| tbl-prefix: "SM"

sigPvalues <- sigSlopes %>%
  select(systemSeason, Scientificname, p.value)

sigRawSlopes <- sigSlopes %>%
  select(systemSeason, Scientificname, raw_slope) %>%
  group_by(systemSeason) %>%
  arrange(desc(raw_slope), .by_group = TRUE)

#pander(sigRawSlopes)
```

# References {#sec-references .appendix}
